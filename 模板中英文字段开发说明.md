# 模板中英文字段开发说明

## 概述
本文档详细说明了ProductMind AI项目中模板内容的中英文字段生成逻辑、数据库存储结构和开发注意事项。

## 数据库字段结构

### template_versions 表字段
```sql
-- 英文内容字段
output_content_en: JSONB {
  content: string,        -- 英文内容
  annotations: array,     -- 注释
  language: 'en',         -- 语言标识
  generated_at: timestamp -- 生成时间
}

-- 中文内容字段  
output_content_zh: JSONB {
  content: string,        -- 中文内容
  annotations: array,     -- 注释
  language: 'zh',         -- 语言标识
  generated_at: timestamp -- 生成时间
}

-- MDC规范字段
mdcpromptcontent_en: TEXT, -- 英文MDC开发规范
mdcpromptcontent_zh: TEXT, -- 中文MDC开发规范

-- 其他字段
source_language: TEXT,     -- 源语言 (默认: 'en')
created_by: UUID,          -- 创建者UUID
```

## 批量生产流程

### 1. 英文内容生成流程
```javascript
// 步骤1: 生成英文内容 (硬编码 language: 'en')
const englishRequest = {
  prompt: template.prompt_content,
  project: { name: project.name, description: project.description },
  template: { name_zh: template.name_zh, name_en: template.name_en },
  language: 'en'  // 硬编码为英文
};

const englishResult = await generateWithDeepSeekReasoner(englishRequest);
```

### 2. 中文内容翻译流程
```javascript
// 步骤2: 翻译中文内容 (基于英文内容翻译)
const chineseRequest = {
  prompt: `请将以下内容翻译成中文，保持原有的格式和结构：\n\n${englishResult.content}`,
  project: { name: project.name, description: project.description },
  template: { name_zh: template.name_zh, name_en: template.name_en },
  language: 'zh'  // 翻译为中文
};

const chineseResult = await generateWithDeepSeekReasoner(chineseRequest);
```

### 3. MDC规范生成流程
```javascript
// 步骤3: 生成MDC内容 (同样先英文后中文)
if (template.mdcprompt) {
  const mdcRequest = {
    prompt: template.mdcprompt,
    project: { name: project.name, description: project.description },
    template: { name_zh: template.name_zh, name_en: template.name_en },
    language: 'en'  // 硬编码为英文
  };
  
  const mdcResult = await generateWithDeepSeekReasoner(mdcRequest);
  if (mdcResult.status === 'success') {
    mdcEnglish = mdcResult.content;
    
    // 翻译MDC内容
    const mdcChineseRequest = {
      prompt: `请将以下内容翻译成中文：\n\n${mdcEnglish}`,
      project: { name: project.name, description: project.description },
      template: { name_zh: template.name_zh, name_en: template.name_en },
      language: 'zh'  // 翻译为中文
    };
    
    const mdcChineseResult = await generateWithDeepSeekReasoner(mdcChineseRequest);
    mdcChinese = mdcChineseResult.status === 'success' ? mdcChineseResult.content : mdcEnglish;
  }
}
```

## AI服务语言处理逻辑

### 1. DeepSeek Reasoner 系统提示词
```javascript
const systemPrompt = `你是一个资深的软件架构师和技术专家，专门负责生成高质量的技术方案和软件文档。

语言要求：${request.language === 'zh' ? '请用中文回答，使用专业的技术术语' : 'Please answer in English with professional technical terminology'}

项目信息：
- 项目名称：${request.project.name}
- 项目描述：${request.project.description}

文档类型：
- 文档名称：${request.language === 'zh' ? request.template.name_zh : request.template.name_en}

注意事项：
- 请生成结构化的内容，包含清晰的标题层级
- 技术方案要考虑可行性、扩展性和维护性
- 文档要包含具体的实施步骤和代码示例（如适用）
- 考虑行业最佳实践和最新技术趋势`;
```

### 2. 模拟内容生成逻辑
```javascript
function generateMockContent(request) {
  const { project, template, language } = request;
  
  // 根据language参数生成不同语言的内容
  const content = language === 'zh' 
    ? `# ${template.name_zh}
## 项目概述
**项目名称**: ${project.name}
**项目描述**: ${project.description}
// ... 中文内容
*由DeepSeek Reasoner AI模型生成*`
    : `# ${template.name_en}
## Project Overview
**Project Name**: ${project.name}
**Description**: ${project.description}
// ... 英文内容
*Generated by DeepSeek Reasoner AI Model*`;

  return {
    content,
    status: 'success',
    model: 'deepseek-reasoner',
    tokens: mockTokens,
    reasoning_tokens: mockReasoningTokens
  };
}
```

## 数据库保存逻辑

### 1. 保存数据结构
```javascript
const saveData = {
  template_id: template.id,
  project_id: project.id,
  created_by: realUserId,  // 使用真实用户UUID
  input_content: `项目: ${project.name}\n描述: ${project.description}`,
  
  // 英文内容
  output_content_en: {
    content: englishContent,
    annotations: [],
    language: 'en',
    generated_at: new Date().toISOString()
  },
  
  // 中文内容
  output_content_zh: {
    content: chineseContent,
    annotations: [],
    language: 'zh',
    generated_at: new Date().toISOString()
  },
  
  // MDC规范内容
  mdcpromptcontent_en: mdcEnglish,
  mdcpromptcontent_zh: mdcChinese,
  
  is_active: true,
  source_language: 'en',  // 源语言为英文
  created_at: new Date().toISOString()
};
```

### 2. Supabase API调用
```javascript
const response = await fetch(`${SUPABASE_URL}/rest/v1/template_versions`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
    'apikey': SUPABASE_SERVICE_KEY,
    'Prefer': 'return=representation'
  },
  body: JSON.stringify(saveData)
});
```

## 开发注意事项

### 1. 语言参数处理
- **硬编码设置**: `language: 'en'` 和 `language: 'zh'` 在批量生产脚本中硬编码
- **先英文后中文**: 先生成英文内容，再翻译成中文
- **系统提示词**: 通过 `systemPrompt` 中的条件判断设置语言要求

### 2. 错误处理
```javascript
// 英文内容生成失败处理
if (englishResult.status !== 'success') {
  throw new Error(`英文内容生成失败: ${englishResult.error}`);
}

// 中文翻译失败处理
const chineseContent = chineseResult.status === 'success' ? chineseResult.content : englishResult.content;

// MDC内容翻译失败处理
mdcChinese = mdcChineseResult.status === 'success' ? mdcChineseResult.content : mdcEnglish;
```

### 3. 内容质量保证
- **格式保持**: 翻译时保持原有的格式和结构
- **专业术语**: 使用专业的技术术语
- **结构化内容**: 包含清晰的标题层级
- **代码示例**: 包含具体的实施步骤和代码示例

### 4. 性能优化
- **分批处理**: 避免一次性处理过多任务
- **错误重试**: 实现错误重试机制
- **超时处理**: 设置合理的API调用超时时间
- **缓存策略**: 考虑缓存已生成的内容

## 常见问题及解决方案

### 1. UUID格式错误
**问题**: `invalid input syntax for type uuid: "system-batch"`
**解决**: 使用真实用户UUID `'afd0fdbc-4ad3-4e92-850b-7c26b2d8efc1'`

### 2. 语言参数无效
**问题**: MockAIService无视language参数
**解决**: 确保 `generateMockContent` 函数正确处理语言参数

### 3. 翻译质量不佳
**问题**: 中文翻译内容质量差
**解决**: 优化翻译提示词，增加格式保持要求

### 4. 数据库连接失败
**问题**: Supabase连接超时或失败
**解决**: 检查环境变量配置，实现重试机制

## 测试验证

### 1. 单任务测试
```javascript
// 测试单个任务的完整流程
const testResult = await testSingleTask();
console.log('测试结果:', testResult);
```

### 2. 批量生产测试
```javascript
// 测试批量生产流程
const batchResult = await executeBatchProduction({
  limitProjects: 2,
  limitTemplates: 2,
  batchSize: 1
});
```

### 3. 内容质量验证
- 检查英文内容的专业性和准确性
- 验证中文翻译的完整性和格式保持
- 确认MDC规范内容的实用性

## 后续改进建议

1. **动态语言设置**: 支持通过参数动态设置生成语言
2. **翻译质量优化**: 改进翻译提示词和算法
3. **内容缓存**: 实现生成内容的缓存机制
4. **质量监控**: 建立内容质量监控和评估系统
5. **多语言支持**: 扩展支持更多语言

---

**文档版本**: 1.0  
**创建时间**: 2024年12月19日  
**最后更新**: 2024年12月19日  
**维护人员**: ProductMind AI开发团队 