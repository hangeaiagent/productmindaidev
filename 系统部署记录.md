# ProductMind AI 系统部署记录

## 系统架构概述

ProductMind AI 包含三套系统：
1. **前端系统** - React + Vite 应用 (端口 8888)
2. **Netlify Functions** - 数据库API服务 (端口 8888)
3. **AWS后端服务** - AI内容生成服务 (端口 3001)

## 部署历史记录

### 2025年6月18日 - 重大系统重构部署

#### 问题1: Node.js版本冲突
**现象：**
- 系统使用Node.js v18.20.8，但项目需要v20+
- PM2使用系统Node.js，导致版本不匹配
- 前端构建失败，依赖安装警告

**原因分析：**
- 服务器同时存在系统Node.js v18.20.8和nvm管理的v20.12.2
- PM2默认使用系统Node.js路径
- 新版本依赖要求Node.js >= 20.18.0

**解决方案：**
```bash
# 1. 删除系统Node.js
sudo yum remove nodejs npm -y

# 2. 创建符号链接指向nvm版本
sudo ln -sf /home/ec2-user/.nvm/versions/node/v20.12.2/bin/node /usr/bin/node
sudo ln -sf /home/ec2-user/.nvm/versions/node/v20.12.2/bin/npm /usr/bin/npm

# 3. 验证版本
node --version  # v20.12.2
npm --version   # 10.5.0
```

**预防措施：**
- 统一使用nvm管理Node.js版本
- 部署前检查Node.js版本兼容性
- 更新部署脚本移除nvm环境sourcing

#### 问题2: 数据库表名错误
**现象：**
- http://productmindai.com/ai-products 页面无法获取数据
- API返回空结果或错误
- 前端显示"Login functionality will be implemented"

**原因分析：**
- `netlify/functions-js/get-projects-by-category.cjs` 第138行
- 数据库查询使用错误表名：`user_projectscategory`
- 正确表名应为：`user_projects_category`

**解决方案：**
```javascript
// 错误代码 (第138行)
FROM user_projectscategory upc

// 修复后代码
FROM user_projects_category upc
```

**验证结果：**
```bash
# 测试修复后的函数
node netlify/functions-js/get-projects-by-category.cjs
# ✅ 成功获取 2 个项目，总计 495 个
# Success: true, Projects count: 2
```

#### 问题3: Netlify CLI执行失败
**现象：**
- `npx netlify dev` 命令失败
- PM2日志显示 "npm ERR! could not determine executable to run"
- API端点返回502 Bad Gateway

**原因分析：**
- Netlify CLI在PM2环境下执行异常
- npx命令路径解析问题
- 服务启动失败导致API不可用

**解决方案：**
创建独立的Functions服务器 (`functions-server.cjs`)：
```javascript
const express = require('express');
const cors = require('cors');
require('dotenv').config();

const app = express();
const PORT = 8888;

// 导入functions-js脚本
const getCategories = require('./netlify/functions-js/get-categories.cjs');
const getProjectsByCategory = require('./netlify/functions-js/get-projects-by-category.cjs');
const checkCategoryCodes = require('./netlify/functions-js/check-category-codes.cjs');

// 设置API路由
app.get('/.netlify/functions/get-categories', async (req, res) => {
    const result = await getCategories.handler({
        httpMethod: 'GET',
        queryStringParameters: req.query,
        headers: req.headers
    });
    res.status(result.statusCode || 200).send(result.body);
});

// 其他路由...
```

**部署命令：**
```bash
# 安装依赖
npm install express cors

# 启动服务
pm2 start functions-server.cjs --name "functions-server"
pm2 start aws-backend/src/server.ts --name "aws-backend" --interpreter ts-node
```

#### 问题4: 前端重新构建需求
**现象：**
- 升级Node.js后前端需要重新编译
- 旧的构建文件使用v18编译，与v20不兼容
- 网站访问异常

**解决方案：**
```bash
# 1. 清理旧文件
rm -rf node_modules dist .netlify

# 2. 重新安装依赖
npm install

# 3. 重新构建
npm run build

# 4. 验证构建结果
ls -la dist/
```

#### 问题5: Nginx配置与服务端口不匹配
**现象：**
- Nginx配置代理到错误端口
- API请求返回502错误
- 服务间通信失败

**原因分析：**
- Nginx配置文件 `/etc/nginx/conf.d/productmind.conf` 存在
- 但所有请求都代理到 `localhost:8888`
- 需要确保Functions服务在8888端口正常运行

**解决方案：**
```nginx
# /etc/nginx/conf.d/productmind.conf
server {
    listen 80;
    server_name productmindai.com www.productmindai.com;
    
    # Netlify函数代理到8888端口
    location /.netlify/functions/ {
        proxy_pass http://localhost:8888;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态文件服务
    root /home/productmindaidev/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 最终部署状态

### 服务运行状态
```bash
pm2 status
┌────┬─────────────────────┬─────────────┬─────────┬─────────┬──────────┐
│ id │ name                │ mode        │ pid     │ status  │ memory   │
├────┼─────────────────────┼─────────────┼─────────┼─────────┼──────────┤
│ 0  │ functions-server    │ fork        │ 1811072 │ online  │ 58.9mb   │
│ 1  │ aws-backend         │ fork        │ 1817555 │ online  │ 80.8mb   │
└────┴─────────────────────┴─────────────┴─────────┴─────────┴──────────┘
```

### 测试验证结果
```bash
# API测试成功
curl -s "http://productmindai.com/.netlify/functions/get-categories" | jq .success
# true

curl -s "http://productmindai.com/.netlify/functions/get-projects-by-category?category=全部&search=&language=zh" | jq .success  
# true
```

### 数据库连接验证
- ✅ Supabase连接正常
- ✅ 环境变量加载成功
- ✅ 数据查询返回正确结果
- ✅ 总计495个项目，45个分类

## 部署最佳实践

### 1. 环境准备检查清单
- [ ] Node.js版本兼容性 (>= 20.12.2)
- [ ] 环境变量完整性检查
- [ ] 数据库连接测试
- [ ] 端口占用情况检查

### 2. 部署顺序
1. 停止所有相关服务 `pm2 stop all`
2. 清理旧构建文件 `rm -rf node_modules dist .netlify`
3. 重新安装依赖 `npm install`
4. 重新构建前端 `npm run build`
5. 启动Functions服务器 `pm2 start functions-server.cjs`
6. 启动AWS后端服务 `pm2 start aws-backend/src/server.ts --interpreter ts-node`
7. 验证所有API端点

### 3. 故障排查步骤
1. 检查PM2服务状态 `pm2 status`
2. 查看服务日志 `pm2 logs [service-name]`
3. 测试端口连通性 `curl http://localhost:8888/health`
4. 验证Nginx配置 `sudo nginx -t`
5. 检查数据库连接

### 4. 关键文件备份
- `/etc/nginx/conf.d/productmind.conf` - Nginx配置
- `functions-server.cjs` - Functions服务器
- `netlify/functions-js/` - 数据库API脚本
- `.env` - 环境变量配置

### 5. 监控和维护
- 定期检查PM2服务状态
- 监控服务器资源使用情况
- 备份重要配置文件
- 定期测试API端点可用性

## 经验教训

1. **版本管理重要性**：Node.js版本不兼容会导致各种奇怪的问题，必须统一版本管理。

2. **数据库表名检查**：看似简单的拼写错误可能导致整个功能失效，需要仔细检查。

3. **服务依赖关系**：理解各服务间的依赖关系，确保启动顺序正确。

4. **工具兼容性**：某些CLI工具在特定环境下可能不工作，需要准备替代方案。

5. **完整测试**：部署后必须进行端到端测试，确保所有功能正常。

## 未来改进建议

1. 创建自动化部署脚本，减少人工操作错误
2. 添加健康检查和自动重启机制
3. 实施配置文件版本控制
4. 建立完整的测试套件
5. 添加性能监控和告警机制 