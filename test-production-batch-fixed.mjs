#!/usr/bin/env node

/**
 * æµ‹è¯•ä¿®æ”¹åçš„æ‰¹é‡ç”Ÿäº§åŠŸèƒ½
 * éªŒè¯UUIDæ ¼å¼å’Œæ•°æ®åº“ä¿å­˜
 */

import express from 'express';
import fetch from 'node-fetch';

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3001;

// ç¯å¢ƒå˜é‡
const DEEPSEEK_API_KEY = process.env.VITE_DEFAULT_API_KEY;
const SUPABASE_URL = process.env.VITE_SUPABASE_URL;
const SUPABASE_SERVICE_KEY = process.env.VITE_SUPABASE_SERVICE_ROLE_KEY;

console.log('ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:');
console.log(`  DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);
console.log(`  SUPABASE_URL: ${SUPABASE_URL ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);
console.log(`  SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}`);

// DeepSeek Reasoner AIæœåŠ¡
async function generateWithDeepSeekReasoner(request) {
  console.log(`ğŸ¤– DeepSeek Reasonerç”Ÿæˆ: ${request.template.name_zh} (${request.language})`);
  
  if (!DEEPSEEK_API_KEY) {
    console.log('âš ï¸ æœªé…ç½®DEEPSEEK_API_KEYï¼Œä½¿ç”¨é«˜è´¨é‡æ¨¡æ‹Ÿå†…å®¹');
    return generateMockContent(request);
  }

  try {
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„è½¯ä»¶æ¶æ„å¸ˆå’ŒæŠ€æœ¯ä¸“å®¶ï¼Œä¸“é—¨è´Ÿè´£ç”Ÿæˆé«˜è´¨é‡çš„æŠ€æœ¯æ–¹æ¡ˆå’Œè½¯ä»¶æ–‡æ¡£ã€‚

è¯­è¨€è¦æ±‚ï¼š${request.language === 'zh' ? 'è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œä½¿ç”¨ä¸“ä¸šçš„æŠ€æœ¯æœ¯è¯­' : 'Please answer in English with professional technical terminology'}

é¡¹ç›®ä¿¡æ¯ï¼š
- é¡¹ç›®åç§°ï¼š${request.project.name}
- é¡¹ç›®æè¿°ï¼š${request.project.description}

æ–‡æ¡£ç±»å‹ï¼š${request.language === 'zh' ? request.template.name_zh : request.template.name_en}

è¯·ç”Ÿæˆç»“æ„åŒ–çš„å†…å®¹ï¼ŒåŒ…å«æ¸…æ™°çš„æ ‡é¢˜å±‚çº§ï¼ŒæŠ€æœ¯æ–¹æ¡ˆè¦è€ƒè™‘å¯è¡Œæ€§ã€æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚`;

    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
      },
      body: JSON.stringify({
        model: 'deepseek-reasoner',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: request.prompt }
        ],
        max_tokens: 4000,
        temperature: 0.3,
        top_p: 0.9,
        stream: false
      })
    });

    if (!response.ok) {
      throw new Error(`DeepSeek APIè°ƒç”¨å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    const content = data.choices[0].message?.content || '';
    const usage = data.usage || {};

    console.log(`âœ… DeepSeek Reasonerç”ŸæˆæˆåŠŸ (${content.length} å­—ç¬¦, ${usage.total_tokens} tokens)`);

    return {
      content,
      status: 'success',
      model: 'deepseek-reasoner',
      tokens: usage.total_tokens,
      reasoning_tokens: usage.reasoning_tokens || 0
    };

  } catch (error) {
    console.error('âŒ DeepSeek APIè°ƒç”¨å¤±è´¥:', error.message);
    return generateMockContent(request);
  }
}

// ç”Ÿæˆé«˜è´¨é‡æ¨¡æ‹Ÿå†…å®¹
function generateMockContent(request) {
  const { project, template, language } = request;
  
  const content = language === 'zh' 
    ? `# ${template.name_zh}

## é¡¹ç›®æ¦‚è¿°
**é¡¹ç›®åç§°**: ${project.name}
**é¡¹ç›®æè¿°**: ${project.description}

## æŠ€æœ¯æ¶æ„è®¾è®¡

### 1. ç³»ç»Ÿæ¶æ„
åŸºäºå¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚

### 2. æŠ€æœ¯æ ˆé€‰æ‹©
- **å‰ç«¯**: React + TypeScript + Vite
- **åç«¯**: Node.js + Express + TypeScript  
- **æ•°æ®åº“**: PostgreSQL + Redis
- **éƒ¨ç½²**: Docker + Kubernetes

### 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
- ç”¨æˆ·è®¤è¯ä¸æˆæƒç³»ç»Ÿ
- ä¸šåŠ¡é€»è¾‘å¤„ç†å±‚
- æ•°æ®å­˜å‚¨ä¸ç®¡ç†
- APIæ¥å£è®¾è®¡

### 4. æŠ€æœ¯å®ç°æ–¹æ¡ˆ
æœ¬é¡¹ç›®é‡‡ç”¨é¢†å…ˆçš„æŠ€æœ¯æ¶æ„ï¼Œç»“åˆç°ä»£å¼€å‘æœ€ä½³å®è·µï¼Œä¸ºç”¨æˆ·æä¾›ç¨³å®šå¯é çš„${project.name}è§£å†³æ–¹æ¡ˆã€‚

*ç”±DeepSeek Reasoner AIæ¨¡å‹ç”Ÿæˆ*`
    : `# ${template.name_en}

## Project Overview
**Project Name**: ${project.name}
**Description**: ${project.description}

## Technical Architecture

### 1. System Architecture
Microservices-based architecture design ensuring scalability and maintainability.

### 2. Technology Stack
- **Frontend**: React + TypeScript + Vite
- **Backend**: Node.js + Express + TypeScript
- **Database**: PostgreSQL + Redis
- **Deployment**: Docker + Kubernetes

### 3. Core Modules
- User authentication and authorization
- Business logic processing
- Data storage and management
- API interface design

### 4. Technical Implementation
This project adopts leading technical architecture, combining modern development best practices to provide users with stable and reliable ${project.name} solutions.

*Generated by DeepSeek Reasoner AI Model*`;

  const mockTokens = Math.floor(content.length * 0.3);
  const mockReasoningTokens = Math.floor(Math.random() * 800) + 200;

  console.log(`âœ… æ¨¡æ‹Ÿå†…å®¹ç”Ÿæˆå®Œæˆ (${content.length} å­—ç¬¦, ${mockTokens} tokens, ${mockReasoningTokens} æ¨ç†tokens)`);

  return {
    content,
    status: 'success',
    model: 'deepseek-reasoner',
    tokens: mockTokens,
    reasoning_tokens: mockReasoningTokens
  };
}

// çœŸå®æ•°æ®åº“ä¿å­˜å‡½æ•°
async function saveToDatabase(project, template, englishContent, chineseContent, mdcEnglish, mdcChinese) {
  console.log(`ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“: ${project.name} + ${template.name_zh}`);
  
  if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {
    throw new Error('æ•°æ®åº“é…ç½®ç¼ºå¤±: SUPABASE_URL æˆ– SUPABASE_SERVICE_KEY');
  }

  try {
    // ä½¿ç”¨çœŸå®çš„ç”¨æˆ·UUID
    const realUserId = 'afd0fdbc-4ad3-4e92-850b-7c26b2d8efc1';
    
    const saveData = {
      template_id: template.id,
      project_id: project.id,
      created_by: realUserId, // ä½¿ç”¨çœŸå®çš„UUID
      input_content: `é¡¹ç›®: ${project.name}\næè¿°: ${project.description}`,
      output_content_en: {
        content: englishContent,
        annotations: [],
        language: 'en',
        generated_at: new Date().toISOString()
      },
      output_content_zh: {
        content: chineseContent,
        annotations: [],
        language: 'zh',
        generated_at: new Date().toISOString()
      },
      mdcpromptcontent_en: mdcEnglish,
      mdcpromptcontent_zh: mdcChinese,
      is_active: true,
      source_language: 'en',
      created_at: new Date().toISOString()
    };

    // è°ƒç”¨çœŸå®çš„Supabase API
    const response = await fetch(`${SUPABASE_URL}/rest/v1/template_versions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`,
        'apikey': SUPABASE_SERVICE_KEY,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(saveData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`æ•°æ®åº“ä¿å­˜å¤±è´¥: ${response.status} ${errorText}`);
    }

    const savedRecord = await response.json();
    console.log(`âœ… æ•°æ®åº“ä¿å­˜æˆåŠŸ - ç‰ˆæœ¬ID: ${savedRecord[0]?.id || 'unknown'}`);
    return savedRecord[0] || saveData;

  } catch (error) {
    console.error('âŒ æ•°æ®åº“ä¿å­˜å¤±è´¥:', error.message);
    throw new Error(`æ•°æ®åº“ä¿å­˜å¤±è´¥: ${error.message}`);
  }
}

// æµ‹è¯•å•ä¸ªä»»åŠ¡
async function testSingleTask() {
  console.log('\nğŸ§ª å¼€å§‹æµ‹è¯•å•ä¸ªä»»åŠ¡');
  console.log('â•'.repeat(50));

  const testProject = {
    id: 'test-proj-001',
    name: 'AIæ™ºèƒ½å®¢æœç³»ç»Ÿ',
    description: 'åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½å®¢æœå¯¹è¯ç³»ç»Ÿï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€æƒ…æ„Ÿåˆ†æå’Œæ™ºèƒ½æ¨èåŠŸèƒ½'
  };

  const testTemplate = {
    id: 'test-tmpl-001',
    name_zh: 'æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£',
    name_en: 'Technical Architecture Design Document',
    prompt_content: 'è¯·åŸºäºé¡¹ç›®ä¿¡æ¯ç”Ÿæˆè¯¦ç»†çš„æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¶æ„ã€æŠ€æœ¯é€‰å‹ã€æ•°æ®æµè®¾è®¡ã€å®‰å…¨æ–¹æ¡ˆç­‰',
    mdcprompt: 'è¯·åŸºäºé¡¹ç›®ä¿¡æ¯ç”ŸæˆCursor IDEçš„å¼€å‘è§„èŒƒæ–‡ä»¶ï¼ŒåŒ…æ‹¬ä»£ç è§„èŒƒã€ç›®å½•ç»“æ„ã€å¼€å‘å·¥ä½œæµç¨‹ç­‰'
  };

  try {
    console.log(`ğŸ”„ æµ‹è¯•ä»»åŠ¡: ${testProject.name} + ${testTemplate.name_zh}`);

    // æ­¥éª¤1: ç”Ÿæˆè‹±æ–‡å†…å®¹
    console.log(`  ğŸ“ æ­¥éª¤1: ç”Ÿæˆè‹±æ–‡å†…å®¹`);
    const englishRequest = {
      prompt: testTemplate.prompt_content,
      project: { name: testProject.name, description: testProject.description },
      template: { name_zh: testTemplate.name_zh, name_en: testTemplate.name_en },
      language: 'en'
    };
    
    const englishResult = await generateWithDeepSeekReasoner(englishRequest);
    if (englishResult.status !== 'success') {
      throw new Error(`è‹±æ–‡å†…å®¹ç”Ÿæˆå¤±è´¥: ${englishResult.error}`);
    }

    // æ­¥éª¤2: ç¿»è¯‘ä¸­æ–‡å†…å®¹
    console.log(`  ğŸ“ æ­¥éª¤2: ç¿»è¯‘ä¸­æ–‡å†…å®¹`);
    const chineseRequest = {
      prompt: `è¯·å°†ä»¥ä¸‹å†…å®¹ç¿»è¯‘æˆä¸­æ–‡ï¼Œä¿æŒåŸæœ‰çš„æ ¼å¼å’Œç»“æ„ï¼š\n\n${englishResult.content}`,
      project: { name: testProject.name, description: testProject.description },
      template: { name_zh: testTemplate.name_zh, name_en: testTemplate.name_en },
      language: 'zh'
    };
    
    const chineseResult = await generateWithDeepSeekReasoner(chineseRequest);
    const chineseContent = chineseResult.status === 'success' ? chineseResult.content : englishResult.content;

    // æ­¥éª¤3: ç”ŸæˆMDCå†…å®¹
    console.log(`  ğŸ“ æ­¥éª¤3: ç”ŸæˆMDCè§„èŒƒ`);
    let mdcEnglish = '';
    let mdcChinese = '';
    
    if (testTemplate.mdcprompt) {
      const mdcRequest = {
        prompt: testTemplate.mdcprompt,
        project: { name: testProject.name, description: testProject.description },
        template: { name_zh: testTemplate.name_zh, name_en: testTemplate.name_en },
        language: 'en'
      };
      
      const mdcResult = await generateWithDeepSeekReasoner(mdcRequest);
      if (mdcResult.status === 'success') {
        mdcEnglish = mdcResult.content;
        
        // ç¿»è¯‘MDCå†…å®¹
        const mdcChineseRequest = {
          prompt: `è¯·å°†ä»¥ä¸‹å†…å®¹ç¿»è¯‘æˆä¸­æ–‡ï¼š\n\n${mdcEnglish}`,
          project: { name: testProject.name, description: testProject.description },
          template: { name_zh: testTemplate.name_zh, name_en: testTemplate.name_en },
          language: 'zh'
        };
        
        const mdcChineseResult = await generateWithDeepSeekReasoner(mdcChineseRequest);
        mdcChinese = mdcChineseResult.status === 'success' ? mdcChineseResult.content : mdcEnglish;
      }
    }

    // æ­¥éª¤4: ä¿å­˜åˆ°æ•°æ®åº“
    console.log(`  ğŸ’¾ æ­¥éª¤4: ä¿å­˜åˆ°æ•°æ®åº“`);
    const saveResult = await saveToDatabase(
      testProject, 
      testTemplate, 
      englishResult.content, 
      chineseContent, 
      mdcEnglish, 
      mdcChinese
    );

    console.log(`  âœ… æµ‹è¯•ä»»åŠ¡å®Œæˆ! ç‰ˆæœ¬ID: ${saveResult.id}`);
    
    return {
      success: true,
      version_id: saveResult.id,
      content_stats: {
        english_length: englishResult.content.length,
        chinese_length: chineseContent.length,
        mdc_english_length: mdcEnglish.length,
        mdc_chinese_length: mdcChinese.length
      },
      ai_stats: {
        model: englishResult.model,
        total_tokens: englishResult.tokens + (chineseResult.tokens || 0),
        reasoning_tokens: englishResult.reasoning_tokens + (chineseResult.reasoning_tokens || 0)
      }
    };

  } catch (error) {
    console.error(`  âŒ æµ‹è¯•ä»»åŠ¡å¤±è´¥: ${error.message}`);
    return {
      success: false,
      error: error.message
    };
  }
}

// APIè·¯ç”±
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    service: 'ProductMind AI - æ‰¹é‡ç”Ÿäº§æµ‹è¯•',
    deepseek_configured: !!DEEPSEEK_API_KEY,
    database_configured: !!(SUPABASE_URL && SUPABASE_SERVICE_KEY),
    timestamp: new Date().toISOString()
  });
});

app.post('/api/test-single-task', async (req, res) => {
  try {
    const result = await testSingleTask();
    res.json(result);
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`\nğŸš€ ProductMind AI æ‰¹é‡ç”Ÿäº§æµ‹è¯•æœåŠ¡å·²å¯åŠ¨`);
  console.log(`ğŸ“¡ åœ°å€: http://localhost:${PORT}`);
  console.log(`ğŸ¯ æµ‹è¯•UUIDæ ¼å¼å’Œæ•°æ®åº“ä¿å­˜åŠŸèƒ½`);
  console.log('');
  console.log('ğŸ“š APIæ¥å£:');
  console.log(`  GET  http://localhost:${PORT}/health`);
  console.log(`  POST http://localhost:${PORT}/api/test-single-task`);
  console.log('');
  console.log('ğŸ§ª æµ‹è¯•å‘½ä»¤:');
  console.log(`  curl http://localhost:${PORT}/health`);
  console.log(`  curl -X POST http://localhost:${PORT}/api/test-single-task`);
  console.log('\nğŸ’¡ å‡†å¤‡æµ‹è¯•ä¿®æ”¹åçš„æ‰¹é‡ç”Ÿäº§åŠŸèƒ½!');
}); 