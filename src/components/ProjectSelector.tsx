import React, { useState, useEffect, useRef } from 'react';
import { Plus, FolderOpen, Save, Download, Play, AlertTriangle, RefreshCw } from 'lucide-react';
import { SafeLoader } from './SafeLoader';
import { stateManager } from '../utils/stateManager';
import { useAppContext } from '../context/AppContext'; 
import { supabase } from '../lib/supabase';
import { useAuth } from '../context/AuthContext';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { logger } from '../utils/logger';
import JSZip from 'jszip';
import * as marked from 'marked';
import { ErrorBoundaryProps, ErrorBoundaryState, GenerationState } from '../types/error-boundary';
import type { Project, TemplateVersion, Template } from '../types';
import { Document, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle, Packer, AlignmentType } from 'docx';
import html2canvas from 'html2canvas';
import { jsPDF } from 'jspdf';
import { FunctionCaller } from '../utils/functionCaller';
import { translationService } from '../services/translationService';

// è½¬æ¢ Markdown ä¸º Word æ–‡æ¡£
const convertMarkdownToDocx = async (markdown: string): Promise<Document> => {
  try {
    logger.log('å¼€å§‹è½¬æ¢Markdownä¸ºWord', { contentLength: markdown.length });
    
    // å°† Markdown è½¬æ¢ä¸º HTML
    const htmlContent = String(marked.parse(markdown));
    logger.log('Markdownè½¬æ¢ä¸ºHTMLå®Œæˆ', { htmlLength: htmlContent.length });

    // å°† HTML è½¬æ¢ä¸ºæ–‡æ¡£æ®µè½
    const paragraphs = htmlContent
      .split('\n')
      .filter((line: string) => line.trim())
      .map((line: string) => {
        return new Paragraph({
          children: [
            new TextRun({
              text: line.replace(/<[^>]*>/g, ''), // ç§»é™¤HTMLæ ‡ç­¾
              size: 24,
            }),
          ],
        });
      });

    logger.log('HTMLè½¬æ¢ä¸ºæ®µè½å®Œæˆ', { paragraphsCount: paragraphs.length });

    // åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡æ¡£ï¼Œæ­£ç¡®ä½¿ç”¨æ„é€ å‡½æ•°
    const doc = new Document({
      sections: [{
        properties: {},
        children: paragraphs
      }],
      creator: "ProductMind AI",
      description: "Generated by ProductMind AI",
      title: "ProductMind AI Document"
    });

    logger.log('Wordæ–‡æ¡£åˆ›å»ºå®Œæˆ');
    return doc;
  } catch (error) {
    logger.error('è½¬æ¢Markdownåˆ°Wordå¤±è´¥', { error });
    throw error;
  }
};

interface VersionWithTemplate extends TemplateVersion {
  template?: {
    id: string;
    name_zh: string;
    name_en: string;
    category?: {
      id: string;
      name_zh: string;
      name_en: string;
    };
  };
}

// æ”¹è¿›çš„ErrorBoundary
class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    console.log('[ErrorBoundary] æ•è·åˆ°é”™è¯¯ï¼Œå¼€å§‹æ¸…ç†æ‰€æœ‰çŠ¶æ€...');
    // æ¸…ç†æ‰€æœ‰çŠ¶æ€
    stateManager.cleanupAll();
    // é¢å¤–æ¸…ç†è¿›åº¦ç›¸å…³çŠ¶æ€
    try {
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      console.log('[ErrorBoundary] çŠ¶æ€æ¸…ç†å®Œæˆ');
    } catch (e) {
      console.error('[ErrorBoundary] æ¸…ç†çŠ¶æ€æ—¶å‡ºé”™:', e);
    }
    return { hasError: true };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo): void {
    logger.error('[ErrorBoundary] ç»„ä»¶é”™è¯¯è¯¦æƒ…', {
      error: error.message,
      componentStack: errorInfo.componentStack,
      errorStack: error.stack
    });
  }

  render(): React.ReactNode {
    if (this.state.hasError) {
      return (
        <div className="p-6 bg-green-50 border border-green-200 rounded-lg shadow-lg">
          <h3 className="text-green-600 font-medium mb-3 flex items-center">
            <AlertTriangle className="w-5 h-5 mr-2" />
            ç³»ç»Ÿæç¤º
          </h3>
          <p className="text-green-700 text-sm mb-4">
            ç”±äºå¼‚å¸¸é€€å‡ºï¼Œå¯¼è‡´æœ¬åœ°æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ã€‚
          </p>
          
          <div className="bg-orange-50 border border-orange-200 p-3 rounded mb-4">
            <p className="text-orange-700 text-sm">
              <strong>æ³¨æ„ï¼š</strong>å› ä¸ºä¸Šè¿°æƒ…å†µï¼Œç¼ºå°‘è¿›åº¦æé†’å¯¹è¯æ¡†ï¼Œä½†ä¸å½±å“é¡¹ç›®æ–‡æ¡£æ­£å¸¸ç”Ÿæˆã€‚
            </p>
          </div>
          
          <div className="bg-white bg-opacity-50 p-4 rounded-lg mb-4">
            <h4 className="text-green-600 font-medium mb-2">æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜çš„æ–¹æ³•ï¼š</h4>
            <div className="text-green-700 text-sm space-y-2">
              <ol className="list-decimal list-inside space-y-1">
                <li className="font-medium">æ¸…ç†æµè§ˆå™¨ç¼“å­˜ï¼š</li>
                <ul className="list-disc list-inside ml-4 space-y-1">
                  <li>æ‰“å¼€æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰</li>
                  <li>å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®</li>
                  <li>é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"ï¼ˆEmpty Cache and Hard Reloadï¼‰</li>
                </ul>
              </ol>
              
              <div className="mt-4 text-sm">
                <p className="mb-2">è¯¦ç»†æ“ä½œè¯´æ˜ï¼š</p>
                <div className="space-y-1">
                  <a 
                    href="https://pangea.hisense.com/syma/clear-cache.html"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-green-600 hover:text-green-700 hover:underline block"
                  >
                    ğŸ”— ä¸­æ–‡ç‰ˆæ“ä½œè¯´æ˜
                  </a>
                  <a 
                    href="https://help.codehs.com/en/articles/4951972-how-to-clear-your-browser-cache-and-hard-refresh"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-green-600 hover:text-green-700 hover:underline block"
                  >
                    ğŸ”— English Version Guide
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

interface GenerationResult {
  templateName: string;
  status: 'success' | 'failed';
  error?: string;
}

const ProjectSelector: React.FC = () => {
  const { 
    language, 
    currentProject, 
    setCurrentProject, 
    setSelectedTemplate,
    setStreamingOutput,
    loadProjectHistory,
    generateOutput
  } = useAppContext();
  
  const { user, isAuthenticated } = useAuth();
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const projectId = searchParams.get('projectId');
  const [projects, setProjects] = useState<Project[]>([]);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const [showDownloadOptions, setShowDownloadOptions] = useState(false);
  const [isGeneratingAll, setIsGeneratingAll] = useState(false);
  const [generationProgress, setGenerationProgress] = useState(0);
  const [totalTemplates, setTotalTemplates] = useState(0);
  const [showGenerationSummary, setShowGenerationSummary] = useState(false);
  const [generationResults, setGenerationResults] = useState<GenerationResult[]>([]);
  const [currentGenerating, setCurrentGenerating] = useState<string>('');
  const [nextToGenerate, setNextToGenerate] = useState<string>('');
  const mountedRef = useRef(true);

  // ç»„ä»¶å¸è½½æ—¶æ¸…ç†
  useEffect(() => {
    console.log('[ProjectSelector] ç»„ä»¶æŒ‚è½½');
    mountedRef.current = true;
    
    return () => {
      console.log('[ProjectSelector] ç»„ä»¶å¸è½½ï¼Œå¼€å§‹æ¸…ç†...');
      mountedRef.current = false;
      // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨å’Œå¼‚æ­¥æ“ä½œ
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      // é‡ç½®æœ¬åœ°çŠ¶æ€
      resetGenerationState();
      logger.debug('ProjectSelector unmounted and cleaned up', {
        trigger: 'component_unmount',
        timestamp: new Date().toISOString()
      });
    };
  }, []);

  // åˆå§‹åŒ–æ—¶æ¸…ç†é—ç•™çŠ¶æ€
  useEffect(() => {
    logger.debug('ProjectSelector initialized, cleaning legacy states', {
      trigger: 'component_init',
      timestamp: new Date().toISOString()
    });
    // ç›´æ¥æ¸…ç†æ‰€æœ‰ç”Ÿæˆç›¸å…³çŠ¶æ€
    stateManager.clearState('generationState');
    stateManager.clearState('generationProgress');
    stateManager.clearState('currentGeneratingTemplate');
    stateManager.clearState('generationResults');
    resetGenerationState();
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ç”Ÿæˆä»»åŠ¡
    const savedState = stateManager.loadState<GenerationState>('generationState');
    if (savedState) {
      logger.debug('Found and cleaned legacy generation state', {
        state: savedState,
        trigger: 'state_cleanup',
        timestamp: new Date().toISOString()
      });
    }
  }, []);

  useEffect(() => {
    if (user) {
      loadProjects();
    }
  }, [user]);

  useEffect(() => {
    if (projects.length > 0) {
      // å¦‚æœURLä¸­æœ‰projectIdï¼Œé€‰æ‹©å¯¹åº”é¡¹ç›®
      if (projectId) {
        const project = projects.find(p => p.id === projectId);
        if (project) {
          setCurrentProject(project);
          return;
        }
      }
      
      // å¦åˆ™é€‰æ‹©é»˜è®¤é¡¹ç›®ï¼Œå¦‚æœæ²¡æœ‰é»˜è®¤é¡¹ç›®åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
      const defaultProject = projects.find(p => p.is_default) || projects[0];
      if (defaultProject) {
        setCurrentProject(defaultProject);
        setSearchParams({ projectId: defaultProject.id });
      }
    }
  }, [projects, projectId]);

  // æ·»åŠ é‡ç½®ç”ŸæˆçŠ¶æ€çš„å‡½æ•°
  const resetGenerationState = () => {
    console.log('[ProjectSelector] é‡ç½®ç”ŸæˆçŠ¶æ€...');
    setIsGeneratingAll(false);
    setGenerationProgress(0);
    setGenerationResults([]);
    setCurrentGenerating('');
    setNextToGenerate('');
    setTotalTemplates(0);
    console.log('[ProjectSelector] ç”ŸæˆçŠ¶æ€é‡ç½®å®Œæˆ');
  };

  const loadProjects = async () => {
    try {
      setIsLoading(true);
      setError(null);
      
      if (!user?.id) {
        setProjects([]);
        return;
      }
      
      const { data, error: fetchError } = await supabase
        .from('user_projects')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (fetchError) {
        throw new Error(language === 'zh' ? 
          'åŠ è½½é¡¹ç›®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : 
          'Failed to load projects, please check your network connection'
        );
      }
      
      setProjects(data || []);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 
        language === 'zh' ? 'åŠ è½½é¡¹ç›®æ—¶å‘ç”Ÿé”™è¯¯' : 'Error loading projects';
      setError(errorMessage);
      console.error('åŠ è½½é¡¹ç›®å¤±è´¥:', err);
    } finally {
      setIsLoading(false);
    }
  };

  const handleNewProject = () => {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if (!isAuthenticated) {
      navigate('/login');
      return;
    }

    setCurrentProject({
      id: '',
      name: '',
      description: '',
      user_id: user?.id || '',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    });
  };

  const handleSaveProject = async () => {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if (!isAuthenticated) {
      navigate('/login');
      return;
    }

    if (!currentProject?.name || !currentProject?.description) {
      setError(language === 'zh' ? 'è¯·å¡«å†™é¡¹ç›®åç§°å’Œæè¿°' : 'Please fill in project name and description');
      return;
    }

    setSaving(true);
    setError(null);

    try {
      logger.debug('å¼€å§‹ä¿å­˜é¡¹ç›®ï¼ˆå«è‡ªåŠ¨ç¿»è¯‘ï¼‰', {
        projectId: currentProject.id,
        name: currentProject.name.substring(0, 50),
        description: currentProject.description?.substring(0, 100)
      });

      // æ£€æµ‹é¡¹ç›®åç§°å’Œæè¿°çš„è¯­è¨€
      const [nameLanguage, descLanguage] = await Promise.all([
        translationService.detectLanguage(currentProject.name),
        translationService.detectLanguage(currentProject.description || '')
      ]);

      logger.debug('è¯­è¨€æ£€æµ‹ç»“æœ', {
        nameLanguage,
        descLanguage,
        name: currentProject.name.substring(0, 30),
        description: currentProject.description?.substring(0, 50)
      });

      // ç¡®ä¿è¯­è¨€ä¸€è‡´æ€§
      if (nameLanguage !== descLanguage) {
        throw new Error(language === 'zh' ? 
          'é¡¹ç›®åç§°å’Œæè¿°çš„è¯­è¨€å¿…é¡»ä¸€è‡´' : 
          'Project name and description must be in the same language'
        );
      }

      const sourceLang = nameLanguage;
      const targetLang = sourceLang === 'zh' ? 'en' : 'zh';

      // è‡ªåŠ¨ç¿»è¯‘åˆ°å¦ä¸€ç§è¯­è¨€
      logger.debug('å¼€å§‹è‡ªåŠ¨ç¿»è¯‘', { sourceLang, targetLang });
      
      const [translatedName, translatedDesc] = await Promise.all([
        translationService.translate(currentProject.name, sourceLang, targetLang),
        currentProject.description ? 
          translationService.translate(currentProject.description, sourceLang, targetLang) : 
          Promise.resolve('')
      ]);

      logger.debug('ç¿»è¯‘å®Œæˆ', {
        translatedName: translatedName.substring(0, 30),
        translatedDesc: translatedDesc.substring(0, 50)
      });

      // å‡†å¤‡æ•°æ®åº“æ•°æ®
      const projectData = {
        name: currentProject.name, // ä¿æŒå…¼å®¹æ€§
        description: currentProject.description || '', // ä¿æŒå…¼å®¹æ€§
        name_zh: sourceLang === 'zh' ? currentProject.name : translatedName,
        name_en: sourceLang === 'en' ? currentProject.name : translatedName,
        description_zh: sourceLang === 'zh' ? currentProject.description : translatedDesc,
        description_en: sourceLang === 'en' ? currentProject.description : translatedDesc,
        source_language: sourceLang,
        updated_at: new Date().toISOString()
      };

      logger.debug('å‡†å¤‡ä¿å­˜é¡¹ç›®æ•°æ®', {
        sourceLang,
        hasNameZh: !!projectData.name_zh,
        hasNameEn: !!projectData.name_en,
        hasDescZh: !!projectData.description_zh,
        hasDescEn: !!projectData.description_en
      });

      if (currentProject.id) {
        // æ›´æ–°ç°æœ‰é¡¹ç›®
        const { error: updateError } = await supabase
          .from('user_projects')
          .update(projectData)
          .eq('id', currentProject.id);

        if (updateError) throw updateError;
        
        logger.debug('é¡¹ç›®æ›´æ–°æˆåŠŸ', { projectId: currentProject.id });
      } else {
        // åˆ›å»ºæ–°é¡¹ç›®
        const { data, error: insertError } = await supabase
          .from('user_projects')
          .insert({
            ...projectData,
            user_id: user?.id,
            is_default: false,
            is_open_source: false,
            model_locked: false
          })
          .select()
          .single();

        if (insertError) throw insertError;
        
        // æ›´æ–°å½“å‰é¡¹ç›®çŠ¶æ€ï¼ŒåŒ…å«å¤šè¯­è¨€å­—æ®µ
        setCurrentProject({
          ...data,
          name_zh: projectData.name_zh,
          name_en: projectData.name_en,
          description_zh: projectData.description_zh,
          description_en: projectData.description_en,
          source_language: projectData.source_language
        });
        
        logger.debug('é¡¹ç›®åˆ›å»ºæˆåŠŸ', { projectId: data.id });
      }
      
      await loadProjects();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const successMessage = language === 'zh' ? 
        `é¡¹ç›®ä¿å­˜æˆåŠŸï¼å·²è‡ªåŠ¨ç”Ÿæˆ${targetLang === 'zh' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}ç‰ˆæœ¬` :
        `Project saved successfully! ${targetLang === 'zh' ? 'Chinese' : 'English'} version auto-generated`;
        
      logger.log('é¡¹ç›®ä¿å­˜å®Œæˆï¼ˆå«ç¿»è¯‘ï¼‰', {
        projectId: currentProject.id,
        sourceLang,
        targetLang,
        message: successMessage
      });
      
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 
        language === 'zh' ? 'ä¿å­˜é¡¹ç›®å¤±è´¥' : 'Failed to save project';
      setError(errorMessage);
      
      logger.error('é¡¹ç›®ä¿å­˜å¤±è´¥', {
        error: err,
        projectId: currentProject.id,
        message: errorMessage
      });
    } finally {
      setSaving(false);
    }
  };

  const handleSetDefault = async (projectId: string) => {
    try {
      logger.debug('Setting default project', { 
        projectId,
        trigger: 'user_action',
        timestamp: new Date().toISOString()
      });
      
      // é¦–å…ˆæ¸…ç©ºæ‰€æœ‰é¡¹ç›®çš„é»˜è®¤æ ‡è®°
      await supabase
        .from('user_projects')
        .update({ is_default: false })
        .eq('user_id', user?.id);

      // ç„¶åè®¾ç½®æŒ‡å®šé¡¹ç›®ä¸ºé»˜è®¤
      const { error: updateError } = await supabase
        .from('user_projects')
        .update({ is_default: true })
        .eq('id', projectId);

      if (updateError) throw updateError;
      
      // æŸ¥æ‰¾å¹¶è®¾ç½®å½“å‰é¡¹ç›®ä¸ºæ–°çš„é»˜è®¤é¡¹ç›®
      const targetProject = projects.find(p => p.id === projectId);
      if (targetProject) {
        setCurrentProject(targetProject);
        setSearchParams({ projectId: targetProject.id });
        logger.debug('Default project updated successfully', {
          projectId: targetProject.id,
          projectName: targetProject.name,
          trigger: 'default_project_set',
          timestamp: new Date().toISOString()
        });
      }
      
      // æ¸…ç©ºé”™è¯¯æé†’å¯¹è¯æ¡†
      setError(null);
      
      await loadProjects();
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 
        language === 'zh' ? 'è®¾ç½®é»˜è®¤é¡¹ç›®å¤±è´¥' : 'Failed to set default project';
      setError(errorMessage);
      logger.error('Failed to set default project', {
        error: err,
        projectId,
        trigger: 'default_project_error',
        timestamp: new Date().toISOString()
      });
    }
  };

  // ç”¨äºæ ¼å¼åŒ–è¾“å‡ºå†…å®¹çš„å‡½æ•°ï¼Œä¸ OutputDisplay ä¸­çš„é€»è¾‘ç›¸åŒ
  const formatOutput = (text: string | null | undefined): string => {
    try {
      if (!text) return '';
      let textStr = String(text);
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯JSONå¯¹è±¡
      if (typeof text === 'object') {
        try {
          const content = (text as any).content || text;
          return typeof content === 'string' ? content : JSON.stringify(content, null, 2);
        } catch (e) {
          return String(text);
        }
      }
      
      // å°è¯•è§£æJSONå­—ç¬¦ä¸²
      try {
        if (textStr.trim().startsWith('{') || textStr.trim().startsWith('[')) {
          const jsonData = JSON.parse(textStr);
          if (jsonData.content) {
            return jsonData.content;
          }
          return JSON.stringify(jsonData, null, 2);
        }
      } catch {
        // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
      }

      return textStr;
    } catch (e) {
      logger.error('æ ¼å¼åŒ–è¾“å‡ºå¤±è´¥', e);
      return '';
    }
  };
  
  // åŠ¨æ€æ’å…¥ç‰ˆæƒä¿¡æ¯å‡½æ•°ï¼Œä¸ OutputDisplay ä¸­çš„é€»è¾‘ç›¸åŒ
  const addCopyrightFooter = (content: string, format: string = 'md'): string => {
    // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©ç‰ˆæƒä¿¡æ¯
    const copyrightText = language === 'zh' ? 
      'æœ¬æ–‡ä»¶ç”± [ProductMind AI](https://productmindai.com) ç”Ÿæˆ' : 
      'Generated by [ProductMind AI](https://productmindai.com)';
    
    let footer = '';
    
    switch (format) {
      case 'md':
        footer = `

---
${copyrightText}
`;
        break;
      case 'docx':
        // Word æ–‡ä»¶çš„ç‰ˆæƒä¿¡æ¯ä¼šåœ¨åé¢å•ç‹¬å¤„ç†
        footer = '';
        break;
      case 'pdf':
        // PDF æ–‡ä»¶çš„ç‰ˆæƒä¿¡æ¯ä¼šåœ¨åé¢å•ç‹¬å¤„ç†
        footer = '';
        break;
      default:
        footer = `

---
${copyrightText}
`;
    }
    
    return content + footer;
  };

  const handleDownloadAll = async (format: 'md') => {
    if (!currentProject?.id) {
      setError(language === 'zh' ? 'è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®' : 'Please select or create a project first');
      return;
    }

    setIsDownloading(true);
    setError(null);

    try {
      logger.log('å¼€å§‹ä¸‹è½½é¡¹ç›®å†…å®¹', { projectId: currentProject.id, format });

      // è·å–æ‰€æœ‰æ´»è·ƒçš„æ¨¡æ¿ç‰ˆæœ¬
      const { data: versions, error: versionsError } = await supabase
        .from('template_versions')
        .select(`
          *,
          template:templates (
            id,
            name_zh,
            name_en,
            category_id,
            category:template_categories (
              id,
              name_zh,
              name_en
            )
          )
        `)
        .eq('project_id', currentProject.id)
        .eq('is_active', true);

      if (versionsError) throw versionsError;

      if (!versions || versions.length === 0) {
        setError(language === 'zh' ? 
          'å½“å‰é¡¹ç›®æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹' : 
          'No content available to download'
        );
        return;
      }

      // åˆ›å»º ZIP æ–‡ä»¶
      const zip = new JSZip();
      
      // æ·»åŠ é¡¹ç›®ä¿¡æ¯æ–‡ä»¶
      const readmeContent = `# ${currentProject.name || ''}\n\n${currentProject.description || ''}\n\n${language === 'zh' ? 'ç”Ÿæˆæ—¶é—´' : 'Generated at'}ï¼š${new Date().toLocaleString()}`;
      zip.file('README.md', readmeContent);
      
      // æŒ‰åˆ†ç±»ç»„ç»‡æ–‡ä»¶
      const groupedVersions = (versions as VersionWithTemplate[]).reduce<Record<string, VersionWithTemplate[]>>((acc, version) => {
        const categoryName = language === 'zh' ? 
          (version.template?.category?.name_zh || 'æœªåˆ†ç±»') : 
          (version.template?.category?.name_en || 'Uncategorized');
        
        if (!acc[categoryName]) {
          acc[categoryName] = [];
        }
        acc[categoryName].push(version);
        return acc;
      }, {});

      // æ·»åŠ æ–‡ä»¶åˆ° ZIP
      for (const [category, categoryVersions] of Object.entries(groupedVersions)) {
        const folder = zip.folder(category);
        if (folder) {
          logger.log(`å¤„ç†åˆ†ç±»: ${category}`, { filesCount: categoryVersions.length });
          
          for (const version of categoryVersions) {
            const templateName = language === 'zh' ? 
              (version.template?.name_zh || 'unnamed') : 
              (version.template?.name_en || 'unnamed');
            
            // ä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶å
            const safeTemplateName = templateName
              .replace(/[<>:"/\\|?*]/g, '')  // ç§»é™¤ä¸å®‰å…¨çš„å­—ç¬¦
              .replace(/\s+/g, '_');         // ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
            
            const fileName = `${safeTemplateName}_V${version.version_number}.${format}`;
            logger.log(`å¤„ç†æ–‡ä»¶: ${fileName}`, { templateId: version.template_id });
            
            // æ ¼å¼åŒ–å†…å®¹
            let rawContent = typeof version.output_content === 'string' 
              ? version.output_content 
              : JSON.stringify(version.output_content, null, 2);
            
            const formattedContent = formatOutput(rawContent);
            logger.log('å†…å®¹æ ¼å¼åŒ–å®Œæˆ', { contentLength: formattedContent.length });

            try {
              // æ·»åŠ Markdownæ ¼å¼çš„ç‰ˆæƒä¿¡æ¯
              const contentWithFooter = addCopyrightFooter(formattedContent, 'md');
              folder.file(fileName, contentWithFooter);
              logger.log('Markdownæ–‡ä»¶æ·»åŠ å®Œæˆ', { fileName });
            } catch (fileError) {
              logger.error(`å¤„ç†æ–‡ä»¶${fileName}å¤±è´¥`, {
                error: fileError,
                format,
                templateName,
                message: fileError instanceof Error ? fileError.message : 'æœªçŸ¥é”™è¯¯',
                stack: fileError instanceof Error ? fileError.stack : undefined
              });
              
              // æ·»åŠ é”™è¯¯ä¿¡æ¯æ–‡ä»¶
              const errorContent = `å¤„ç†æ­¤æ–‡ä»¶æ—¶å‡ºé”™: ${fileError instanceof Error ? fileError.message : 'æœªçŸ¥é”™è¯¯'}\n\nåŸå§‹å†…å®¹:\n${formattedContent}`;
              folder.file(`${fileName}.error.txt`, errorContent);
            }
          }
        }
      }

      // ç”Ÿæˆå¹¶ä¸‹è½½ ZIP æ–‡ä»¶
      const content = await zip.generateAsync({ type: 'blob' });
      
      // ä½¿ç”¨å®‰å…¨çš„é¡¹ç›®åç§°ä½œä¸ºæ–‡ä»¶å
      const safeProjectName = currentProject.name
        .replace(/[<>:"/\\|?*]/g, '')
        .replace(/\s+/g, '_');
      
      const formatName = format.toUpperCase();
      const downloadUrl = URL.createObjectURL(content);
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `${safeProjectName}_${formatName}_${new Date().toISOString().slice(0, 10)}.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(downloadUrl);

      logger.log('æ–‡ä»¶ä¸‹è½½å®Œæˆ', { projectName: currentProject.name, format, filesCount: versions.length });
      setShowDownloadOptions(false);
    } catch (err) {
      logger.error('ä¸‹è½½å¤±è´¥', { 
        error: err, 
        message: err instanceof Error ? err.message : 'æœªçŸ¥é”™è¯¯',
        stack: err instanceof Error ? err.stack : undefined 
      });
      const errorMessage = err instanceof Error ? err.message : 
        language === 'zh' ? 'ä¸‹è½½å¤±è´¥' : 'Download failed';
      setError(errorMessage);
    } finally {
      setIsDownloading(false);
    }
    
    setTimeout(() => {
      setError(null);
    }, 3000);
  };

  const handleGenerateAll = async () => {
    console.log('[ProjectSelector] å¼€å§‹æ‰¹é‡ç”Ÿæˆæµç¨‹...');
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if (!isAuthenticated) {
      console.log('[ProjectSelector] ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
      navigate('/login');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®
    if (!currentProject || !currentProject.id) {
      console.log('[ProjectSelector] æœªé€‰æ‹©é¡¹ç›®');
      setError(language === 'zh' ? 'è¯·å…ˆåˆ›å»ºå¹¶ä¿å­˜é¡¹ç›®' : 'Please create and save a project first');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰äº§å“æè¿°
    if (!currentProject?.description) {
      console.log('[ProjectSelector] é¡¹ç›®æ— æè¿°');
      setError(language === 'zh' ? 'è¯·å…ˆè¾“å…¥äº§å“æè¿°' : 'Please enter product description first');
      return;
    }

    try {
      console.log('[ProjectSelector] æ¸…ç†æ—§çš„ç”ŸæˆçŠ¶æ€...');
      // å…ˆæ¸…ç†æ—§çš„çŠ¶æ€
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      
      // ä¿å­˜åˆå§‹çŠ¶æ€
      const initialState = {
        isGeneratingAll: true,
        generationProgress: 0,
        currentGenerating: '',
        nextToGenerate: '',
        projectId: currentProject.id
      };
      stateManager.saveState('generationState', initialState);

      logger.log('[ProjectSelector] å¼€å§‹æ‰¹é‡ç”Ÿæˆ', {
        projectId: currentProject.id,
        projectName: currentProject.name,
        state: initialState
      });

      // é‡ç½®æ‰€æœ‰çŠ¶æ€
      setIsGeneratingAll(true);
      setGenerationProgress(0);
      setGenerationResults([]);
      setCurrentGenerating('');
      setNextToGenerate('');
      setError(null);

      // æ¸…ç†æœªå®Œæˆçš„ç”Ÿæˆä»»åŠ¡
      const { data: unfinishedVersions, error: cleanupError } = await supabase
        .from('template_versions')
        .select('*')
        .eq('project_id', currentProject.id)
        .eq('is_active', true)
        .is('output_content', null);

      if (cleanupError) throw cleanupError;

      if (unfinishedVersions && unfinishedVersions.length > 0) {
        console.log('[ProjectSelector] æ¸…ç†æœªå®Œæˆçš„ç”Ÿæˆä»»åŠ¡', {
          projectId: currentProject.id,
          versionsCount: unfinishedVersions.length
        });

        const { error: deleteError } = await supabase
          .from('template_versions')
          .delete()
          .in('id', unfinishedVersions.map(v => v.id));

        if (deleteError) throw deleteError;
      }

      // è·å–æ‰€æœ‰æ¨¡æ¿ï¼ŒåŒ…æ‹¬åˆ†ç±»ä¿¡æ¯
      const { data: sortedTemplates, error: templatesError } = await supabase
        .from('templates')
        .select(`
          *,
          category:template_categories!inner (
            id,
            name_zh,
            name_en,
            no
          ),
          versions:template_versions (
            id,
            project_id,
            is_active,
            output_content
          )
        `)
        .order('category(no)', { ascending: true })
        .order('no', { ascending: true });

      if (templatesError) throw templatesError;

      // ç­›é€‰å‡ºæ²¡æœ‰å®Œæˆç”Ÿæˆçš„æ¨¡æ¿
      const templatesToGenerate = sortedTemplates?.filter(template => {
        const hasCompletedVersion = template.versions?.some(
          (version: { project_id: string; is_active: boolean; output_content: any }) => 
            version.project_id === currentProject.id && 
            version.is_active && 
            version.output_content !== null
        );
        return !hasCompletedVersion;
      });

      console.log('[ProjectSelector] è·å–å¾…ç”Ÿæˆæ¨¡æ¿', {
        totalTemplates: templatesToGenerate?.length,
        templates: templatesToGenerate?.map(t => ({
          id: t.id,
          name: language === 'zh' ? t.name_zh : t.name_en
        }))
      });

      if (!templatesToGenerate?.length) {
        console.log('[ProjectSelector] æ²¡æœ‰éœ€è¦ç”Ÿæˆçš„æ¨¡æ¿');
        setError(language === 'zh' ? 'æ²¡æœ‰éœ€è¦ç”Ÿæˆçš„æ¨¡æ¿' : 'No templates to generate');
        setIsGeneratingAll(false);
        // æ¸…ç†çŠ¶æ€
        stateManager.clearState('generationState');
        return;
      }

      setTotalTemplates(templatesToGenerate.length);

      // é€ä¸ªç”Ÿæˆæ¨¡æ¿
      for (let i = 0; i < templatesToGenerate.length; i++) {
        // æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²å¸è½½
        if (!mountedRef.current) {
          console.log('[ProjectSelector] ç»„ä»¶å·²å¸è½½ï¼Œåœæ­¢ç”Ÿæˆ');
          break;
        }
        
        const template = templatesToGenerate[i];
        const templateName = language === 'zh' ? template.name_zh : template.name_en;

        console.log(`[ProjectSelector] ç”Ÿæˆæ¨¡æ¿ ${i + 1}/${templatesToGenerate.length}: ${templateName}`);

        const currentState: GenerationState = {
          isGeneratingAll: true,
          generationProgress: (i / templatesToGenerate.length) * 100,
          currentGenerating: templateName,
          nextToGenerate: i < templatesToGenerate.length - 1 ? 
            (language === 'zh' ? templatesToGenerate[i + 1].name_zh : templatesToGenerate[i + 1].name_en) : '',
          projectId: currentProject.id
        };
        stateManager.saveState('generationState', currentState);

        try {
          await generateOutput(currentProject.description, template);
          
          setGenerationResults(prev => {
            const newResults: GenerationResult[] = [...prev, { 
              templateName, 
              status: 'success' as const 
            }];
            stateManager.saveState('generationState', {
              ...currentState,
              results: newResults
            });
            return newResults;
          });
          console.log(`[ProjectSelector] æ¨¡æ¿ç”ŸæˆæˆåŠŸ: ${templateName}`);
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[ProjectSelector] æ¨¡æ¿ç”Ÿæˆå¤±è´¥: ${templateName}`, errorMessage);
          
          setGenerationResults(prev => {
            const newResults: GenerationResult[] = [...prev, { 
              templateName, 
              status: 'failed' as const,
              error: errorMessage 
            }];
            stateManager.saveState('generationState', {
              ...currentState,
              results: newResults
            });
            return newResults;
          });

          if (error instanceof Error && 
            (error.message.includes('API') || 
             error.message.includes('network') || 
             error.message.includes('authorization'))) {
            console.log('[ProjectSelector] é‡åˆ°ä¸¥é‡é”™è¯¯ï¼Œåœæ­¢ç”Ÿæˆ');
            break;
          }
        }

        setGenerationProgress((i + 1) / templatesToGenerate.length * 100);
      }

      console.log('[ProjectSelector] æ‰¹é‡ç”Ÿæˆå®Œæˆï¼Œæ¸…ç†çŠ¶æ€...');
      // æ¸…ç†æ‰€æœ‰ç”ŸæˆçŠ¶æ€
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      
      setShowGenerationSummary(true);
    } catch (error) {
      console.error('[ProjectSelector] æ‰¹é‡ç”Ÿæˆè¿‡ç¨‹å‘ç”Ÿé”™è¯¯', {
        error: error instanceof Error ? error.message : String(error),
        state: {
          isGeneratingAll,
          generationProgress,
          currentGenerating,
          nextToGenerate,
          results: generationResults
        }
      });
      
      setError(error instanceof Error ? error.message : 
        language === 'zh' ? 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯' : 'Error during generation'
      );
    } finally {
      console.log('[ProjectSelector] æ‰¹é‡ç”Ÿæˆç»“æŸï¼Œæ‰§è¡Œæœ€ç»ˆæ¸…ç†...');
      setIsGeneratingAll(false);
      setCurrentGenerating('');
      setNextToGenerate('');
      // ç¡®ä¿æ¸…ç†æ‰€æœ‰çŠ¶æ€
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      console.log('[ProjectSelector] æ¸…ç†å®Œæˆ');
    }
  };

  // æ·»åŠ ç”Ÿæˆç»“æœæ‘˜è¦å¯¹è¯æ¡†
  const GenerationSummaryDialog = () => {
    if (!showGenerationSummary) return null;

    const successCount = generationResults.filter(r => r.status === 'success').length;
    const failedCount = generationResults.filter(r => r.status === 'failed').length;

    const handleClose = async () => {
      console.log('[GenerationSummaryDialog] å…³é—­æ‘˜è¦å¯¹è¯æ¡†ï¼Œæ¸…ç†çŠ¶æ€...');
      setShowGenerationSummary(false);
      setGenerationResults([]);
      
      // æ¸…ç†æ‰€æœ‰ç”Ÿæˆç›¸å…³çš„æœ¬åœ°å­˜å‚¨
      stateManager.clearState('generationState');
      stateManager.clearState('generationProgress');
      stateManager.clearState('currentGeneratingTemplate');
      stateManager.clearState('generationResults');
      
      // é‡æ–°åŠ è½½é¡¹ç›®å†å²
      if (currentProject?.id) {
        console.log('[GenerationSummaryDialog] é‡æ–°åŠ è½½é¡¹ç›®å†å²...');
        await loadProjectHistory(currentProject.id);
      }
      
      // é€šçŸ¥ AppContext åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
      setSelectedTemplate(null);
      setStreamingOutput('');
      console.log('[GenerationSummaryDialog] çŠ¶æ€æ¸…ç†å®Œæˆ');
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
          <h3 className="text-lg font-semibold mb-4">
            {language === 'zh' ? 'ç”Ÿæˆç»“æœæ‘˜è¦' : 'Generation Summary'}
          </h3>
          
          <div className="mb-4 grid grid-cols-2 gap-4">
            <div className="bg-green-100 dark:bg-green-900 p-3 rounded">
              <div className="text-green-800 dark:text-green-200">
                {language === 'zh' ? 'æˆåŠŸ' : 'Success'}: {successCount}
              </div>
            </div>
            <div className="bg-red-100 dark:bg-red-900 p-3 rounded">
              <div className="text-red-800 dark:text-red-200">
                {language === 'zh' ? 'å¤±è´¥' : 'Failed'}: {failedCount}
              </div>
            </div>
          </div>

          <div className="space-y-3">
            {generationResults.map((result, index) => (
              <div 
                key={index}
                className={`p-3 rounded ${
                  result.status === 'success' 
                    ? 'bg-green-50 dark:bg-green-900/20' 
                    : 'bg-red-50 dark:bg-red-900/20'
                }`}
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="font-medium">{result.templateName}</div>
                    {result.error && (
                      <div className="text-sm text-red-600 dark:text-red-400 mt-1">
                        {result.error}
                      </div>
                    )}
                  </div>
                  <div className={`ml-3 ${
                    result.status === 'success' 
                      ? 'text-green-600 dark:text-green-400' 
                      : 'text-red-600 dark:text-red-400'
                  }`}>
                    {result.status === 'success' 
                      ? (language === 'zh' ? 'æˆåŠŸ' : 'Success')
                      : (language === 'zh' ? 'å¤±è´¥' : 'Failed')
                    }
                  </div>
                </div>
              </div>
            ))}
          </div>

          <div className="mt-6 flex justify-end">
            <button
              onClick={handleClose}
              className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
            >
              {language === 'zh' ? 'å…³é—­' : 'Close'}
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ä¿®æ”¹ç”Ÿæˆè¿›åº¦å¯¹è¯æ¡†ç»„ä»¶
  const GenerationProgressDialog = () => {
    // åªåœ¨ä¸»åŠ¨ç‚¹å‡»ç”ŸæˆæŒ‰é’®åæ˜¾ç¤ºè¿›åº¦æ¡†
    if (!isGeneratingAll) return null;

    return (
      <div className="fixed bottom-4 right-4 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 max-w-md">
        <div className="space-y-3">
          <div className="flex justify-between items-center">
            <div className="text-lg font-medium text-gray-700 dark:text-gray-300">
              {language === 'zh' ? 'ç”Ÿæˆè¿›åº¦' : 'Generation Progress'}
            </div>
          </div>

          {currentGenerating && (
            <div>
              <div className="text-sm font-medium text-gray-700 dark:text-gray-300">
                {language === 'zh' ? 'å½“å‰ç”Ÿæˆ' : 'Currently Generating'}:
                <span className="ml-1 text-blue-600 dark:text-blue-400">{currentGenerating}</span>
              </div>
              {nextToGenerate && (
                <div className="text-sm text-gray-600 dark:text-gray-400">
                  {language === 'zh' ? 'ä¸‹ä¸€ä¸ª' : 'Next'}:
                  <span className="ml-1">{nextToGenerate}</span>
                </div>
              )}
            </div>
          )}

          <div>
            <div className="text-sm text-gray-600 dark:text-gray-400 mb-1">
              {language === 'zh' ? 'è¿›åº¦' : 'Progress'}: {Math.round(generationProgress)}%
            </div>
            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div 
                className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                style={{ width: `${generationProgress}%` }}
              />
            </div>
            <div className="text-xs text-gray-500 dark:text-gray-400 mt-1 text-right">
              {generationResults.length} / {totalTemplates} {language === 'zh' ? 'å·²å®Œæˆ' : 'completed'}
            </div>
          </div>

          {/* æœ€è¿‘å®Œæˆçš„é¡¹ç›®åˆ—è¡¨ */}
          {generationResults.length > 0 && (
            <div className="mt-2">
              <div className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                {language === 'zh' ? 'æœ€è¿‘å®Œæˆ' : 'Recently Completed'}:
              </div>
              <div className="max-h-32 overflow-y-auto">
                {generationResults.slice(-3).map((result, index) => (
                  <div 
                    key={index}
                    className={`text-sm ${
                      result.status === 'success' 
                        ? 'text-green-600 dark:text-green-400' 
                        : 'text-red-600 dark:text-red-400'
                    }`}
                  >
                    {result.templateName}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <ErrorBoundary>
      <div className="bg-white rounded-lg shadow-md p-6 mb-6">
        <div className="mb-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-semibold text-gray-800">
              {language === 'zh' ? 'é¡¹ç›®ä¿¡æ¯' : 'Project Information'}
            </h2>
            <div className="flex space-x-2">
              <button
                onClick={() => {
                  if (!isAuthenticated) {
                    navigate('/login');
                    return;
                  }
                  handleNewProject();
                }}
                className="px-3 py-1.5 text-sm font-medium text-indigo-600 bg-indigo-50 rounded hover:bg-indigo-100"
              >
                <Plus className="w-4 h-4 inline-block mr-1" />
                {language === 'zh' ? 'æ–°å»º' : 'New'}
              </button>
              <div className="relative">
                <button
                  onClick={() => {
                    if (!isAuthenticated) {
                      navigate('/login');
                      return;
                    }
                    setShowDownloadOptions(!showDownloadOptions);
                  }}
                  disabled={isDownloading}
                  className={`px-3 py-1.5 text-sm font-medium rounded ${
                    isDownloading
                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                      : 'text-indigo-600 bg-indigo-50 hover:bg-indigo-100'
                  }`}
                >
                  {isDownloading ? (
                    <>
                      <SafeLoader className="w-4 h-4 inline-block mr-1 animate-spin" />
                      {language === 'zh' ? 'ä¸‹è½½ä¸­...' : 'Downloading...'}
                    </>
                  ) : (
                    <>
                      <Download className="w-4 h-4 inline-block mr-1" />
                      {language === 'zh' ? 'å…¨éƒ¨ä¸‹è½½' : 'Download All'}
                    </>
                  )}
                </button>
                
                {showDownloadOptions && !isDownloading && (
                  <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg ring-1 ring-black ring-opacity-5 z-10">
                    <div className="py-1" role="menu" aria-orientation="vertical">
                      <button
                        onClick={() => handleDownloadAll('md')}
                        className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                        role="menuitem"
                      >
                        {language === 'zh' ? 'å…¨éƒ¨ä¸‹è½½ Markdown' : 'Download All Markdown'}
                      </button>
                    </div>
                  </div>
                )}
              </div>
              <button
                onClick={() => {
                  if (!isAuthenticated) {
                    navigate('/login');
                    return;
                  }
                  handleSaveProject();
                }}
                disabled={saving || !currentProject?.name}
                className={`px-3 py-1.5 text-sm font-medium rounded ${
                  saving || !currentProject?.name
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                    : 'text-white bg-indigo-600 hover:bg-indigo-700'
                }`}
              >
                {saving ? (
                  <>
                    <SafeLoader className="w-4 h-4 inline-block mr-1 animate-spin" />
                    {language === 'zh' ? 'ä¿å­˜ä¸­...' : 'Saving...'}
                  </>
                ) : (
                  <>
                    <Save className="w-4 h-4 inline-block mr-1" />
                    {language === 'zh' ? 'ä¿å­˜' : 'Save'}
                  </>
                )}
              </button>
            </div>
          </div>

          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-sm text-red-600">{error}</p>
            </div>
          )}

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'zh' ? 'é¡¹ç›®åç§°' : 'Project Name'}
              </label>
              <input
                type="text"
                value={currentProject?.name || ''}
                onChange={async (e) => {
                  const value = e.target.value;
                  setCurrentProject(prev => prev ? {
                    ...prev,
                    name: value
                  } : null);
                }}
                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                placeholder={language === 'zh' ? 'é¡¹ç›®åç§°' : 'Project Name'}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'zh' ? 'äº§å“æ¦‚è¿°' : 'Product Overview'}
              </label>
              <div className="relative">
                <textarea
                  value={currentProject?.description || ''}
                  onChange={(e) => {
                    const value = e.target.value;
                    setCurrentProject(prev => prev ? {
                      ...prev,
                      description: value
                    } : null);
                  }}
                  rows={4}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder={language === 'zh' ? 
                    'è¯·ç”¨ä¸€å¥è¯æè¿°æ‚¨çš„äº§å“æ¦‚å¿µï¼ˆä¾‹å¦‚ï¼šå¼€å‘ä¸€ä¸ªå¸®åŠ©ç”¨æˆ·ç®¡ç†æ—¥å¸¸ä»»åŠ¡çš„åº”ç”¨ï¼‰' : 
                    'Describe your product concept in one sentence'
                  }
                  required
                />
                <p className="mt-2 text-sm text-gray-500">
                  {language === 'zh'
                    ? 'ç®€å•æè¿°æ‚¨çš„äº§å“ç†å¿µï¼Œæˆ‘ä»¬å°†å¸®åŠ©æ‚¨è¿›è¡Œæ·±å…¥åˆ†æ'
                    : 'Briefly describe your product concept, and we will help you analyze it in depth'
                  }
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="mt-8">
          <h3 className="text-lg font-medium text-gray-900 mb-4">
            {language === 'zh' ? 'æˆ‘çš„é¡¹ç›®' : 'My Projects'}
          </h3>
          {isLoading ? (
            <div className="flex items-center justify-center py-8">
              <SafeLoader className="w-6 h-6 text-indigo-600 animate-spin" />
              <span className="ml-2 text-gray-600">
                {language === 'zh' ? 'åŠ è½½ä¸­...' : 'Loading...'}
              </span>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {projects.map((project) => (
                <button
                  key={project.id}
                  onClick={() => {
                    setCurrentProject(project);
                    setSearchParams({ projectId: project.id });
                    // æ¸…ç©ºå½“å‰é€‰ä¸­çš„æ¨¡æ¿å’Œè¾“å‡ºå†…å®¹ï¼ŒåŠ è½½æ–°é¡¹ç›®çš„å†å²è®°å½•
                    setSelectedTemplate(null);
                    setStreamingOutput('');
                    // æ¸…ç©ºé”™è¯¯æé†’å¯¹è¯æ¡†
                    setError(null);
                    loadProjectHistory(project.id);
                    logger.log('é¡¹ç›®åˆ‡æ¢', { 
                      projectId: project.id,
                      projectName: project.name,
                      location: 'é¡¹ç›®é€‰æ‹©å™¨ç»„ä»¶:è¡Œå·293'
                    });
                  }}
                  className={`p-4 rounded-lg border ${
                    currentProject?.id === project.id
                      ? 'border-indigo-500 bg-indigo-50'
                      : 'border-gray-200 hover:border-indigo-300'
                  }`}
                >
                  <div className="flex flex-col h-full">
                    <div className="flex items-start space-x-3">
                      <FolderOpen className={`w-5 h-5 ${
                        currentProject?.id === project.id
                          ? 'text-indigo-600'
                          : 'text-gray-400'
                      }`} />
                      <div className="flex-1 text-left">
                        <div className="flex items-center space-x-2">
                                            <h3 className="font-medium text-gray-900">
                    {language === 'zh' ? (project.name_zh || project.name) : (project.name_en || project.name)}
                  </h3>
                  {project.is_default && (
                    <span className="px-2 py-0.5 text-xs bg-indigo-100 text-indigo-600 rounded">
                      {language === 'zh' ? 'é»˜è®¤' : 'Default'}
                    </span>
                  )}
                </div>
                <p className="mt-1 text-sm text-gray-500 line-clamp-3">
                  {language === 'zh' ? (project.description_zh || project.description) : (project.description_en || project.description)}
                </p>
                      </div>
                    </div>
                    {!project.is_default && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleSetDefault(project.id);
                        }}
                        className="mt-3 text-xs text-indigo-600 hover:text-indigo-700"
                      >
                        {language === 'zh' ? 'è®¾ä¸ºé»˜è®¤' : 'Set as default'}
                      </button>
                    )}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        <div className="flex justify-between items-center mt-4">
          <div className="flex space-x-2">
            <button
              onClick={() => {
                if (!isAuthenticated) {
                  navigate('/login');
                  return;
                }
                handleNewProject();
              }}
              className="flex items-center px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              <Plus className="w-4 h-4 mr-2" />
              {language === 'zh' ? 'æ–°å»ºé¡¹ç›®' : 'New Project'}
            </button>
            
            <button
              onClick={() => {
                if (!isAuthenticated) {
                  navigate('/login');
                  return;
                }
                handleGenerateAll();
              }}
              disabled={isGeneratingAll || !currentProject?.id}
              className={`flex items-center px-3 py-2 ${
                isGeneratingAll || !currentProject?.id
                  ? 'bg-gray-400 cursor-not-allowed'
                  : 'bg-green-500 hover:bg-green-600'
              } text-white rounded`}
            >
                          {isGeneratingAll ? (
              <>
                <SafeLoader className="w-4 h-4 mr-2 animate-spin" />
                {language === 'zh' 
                  ? `ç”Ÿæˆä¸­ (${generationResults.length}/${totalTemplates})`
                  : `Generating (${generationResults.length}/${totalTemplates})`
                }
              </>
            ) : (
              <>
                <Play className="w-4 h-4 mr-2" />
                {language === 'zh' ? 'å…¨éƒ¨ç”Ÿæˆ' : 'Generate All'}
              </>
            )}
            </button>
          </div>
        </div>

        {/* æ·»åŠ ç”Ÿæˆè¿›åº¦æç¤º */}
        {isGeneratingAll && (
          <GenerationProgressDialog />
        )}
        
        {/* æ·»åŠ ç”Ÿæˆç»“æœæ‘˜è¦å¯¹è¯æ¡† */}
        <GenerationSummaryDialog />
      </div>
    </ErrorBoundary>
  );
};

export default ProjectSelector;