# AI产品分析方案本地开发后台正确部署和启动指南

## 📅 文档日期
2025年1月7日

## 🎯 问题背景

在使用AI产品创意生成器功能时，前端调用API出现404错误：
```
AIProductIdeaGenerator.tsx:175  POST http://localhost:8888/.netlify/functions/generate-ai-product-analysis 404 (Not Found)
```

### 核心问题分析
1. **错误的API路由**：前端试图调用netlify函数，但实际需要调用AWS后台的DeepSeek API服务
2. **代理配置冲突**：Vite配置中的代理设置导致请求被错误路由
3. **服务架构混乱**：同时存在netlify函数服务器和AWS后台服务器，造成端点混淆

## 🔧 解决方案

### 1. 修改前端配置

**文件**: `vite.config.ts`

**问题**: Vite配置中有代理设置，将所有`/.netlify/functions`请求代理到`http://localhost:8888`

**修改前**:
```typescript
export default defineConfig({
  plugins: [react()],
  server: {
    host:'0.0.0.0',
    port: 5173,
    strictPort: true,
    hmr: {
      clientPort: 5173
    },
    allowedHosts: [
      'localhost',
      'productmindai.com',
      'www.productmindai.com'
    ],
    proxy: {
      // 代理Netlify Functions到8888端口
      '/.netlify/functions': {
        target: 'http://localhost:8888',
        changeOrigin: true,
        secure: false,
        rewrite: (path) => path
      }
    }
  },
  optimizeDeps: {
    exclude: ['lucide-react'],
  },
});
```

**修改后**:
```typescript
export default defineConfig({
  plugins: [react()],
  server: {
    host:'0.0.0.0',
    port: 5173,
    strictPort: true,
    hmr: {
      clientPort: 5173
    },
    allowedHosts: [
      'localhost',
      'productmindai.com',
      'www.productmindai.com'
    ]
    // 移除代理配置，直接调用AWS后台服务
  },
  optimizeDeps: {
    exclude: ['lucide-react'],
  },
});
```

### 2. 前端API端点配置验证

**文件**: `src/components/AIProductIdeaGenerator.tsx`

前端代码已正确配置为调用AWS后台服务：

```typescript
// 流式分析API
const handleStreamingGenerate = async () => {
  const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  const apiUrl = isDevelopment 
    ? 'http://localhost:3000/api/ai-product-analysis-stream'  // ✅ 正确的AWS后台端点
    : '/api/ai-product-analysis-stream';
  // ... 其他代码
};

// 普通分析API
const handleNormalGenerate = async () => {
  const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  const apiUrl = isDevelopment 
    ? 'http://localhost:3000/api/ai-product-analysis'  // ✅ 正确的AWS后台端点
    : '/api/ai-product-analysis';
  // ... 其他代码
};
```

### 3. AWS后台服务器配置

**文件**: `aws-backend/deepseek-api-server.cjs`

AWS后台服务器提供以下端点：
- **健康检查**: `GET http://localhost:3000/health`
- **AI产品分析**: `POST http://localhost:3000/api/ai-product-analysis`
- **流式AI产品分析**: `POST http://localhost:3000/api/ai-product-analysis-stream`

**环境变量**: `aws-backend/.env`
```bash
# 应用配置
NODE_ENV=development
PORT=3000
API_VERSION=v1

# AI API配置 - 关键配置！
DEEPSEEK_API_KEY=sk-567abb67b99d4a65acaa2d9ed06c3782

# CORS配置
CORS_ORIGIN=http://localhost:5173,https://productmindai.com
```

## 🚀 正确的启动流程

### 步骤1：启动AWS后台DeepSeek API服务器

```bash
# 进入AWS后台目录
cd aws-backend

# 确保依赖已安装
npm install

# 启动DeepSeek API服务器
node deepseek-api-server.cjs
```

**预期输出**:
```
🚀 DeepSeek AI Analysis Server 运行在 http://localhost:3000
📋 健康检查: http://localhost:3000/health
🤖 AI产品分析: POST http://localhost:3000/api/ai-product-analysis
🌊 流式AI产品分析: POST http://localhost:3000/api/ai-product-analysis-stream
🔑 DeepSeek API: ✅ 已配置
🎯 将使用DeepSeek Chat大模型进行真实AI分析
```

### 步骤2：启动前端服务

在新的终端窗口中：
```bash
# 回到项目根目录
cd ..

# 启动前端服务
npm run dev
```

**预期输出**:
```
VITE v5.4.19  ready in 912 ms
➜  Local:   http://localhost:5173/
➜  Network: http://172.31.77.15:5173/
```

### 步骤3：验证服务状态

**检查AWS后台服务器**:
```bash
curl http://localhost:3000/health
```

**检查前端服务**:
```bash
curl http://localhost:5173
```

**检查端口占用**:
```bash
netstat -ano | findstr ":3000"  # AWS后台
netstat -ano | findstr ":5173"  # 前端服务
```

## 🧪 功能测试步骤

### 1. 基本功能测试
1. 打开浏览器访问: http://localhost:5173
2. 导航到"AI产品创意生成器"
3. 输入产品需求，例如：
   ```
   我想做一个基于AI的智能数据分析工具，用户可以通过自然语言查询业务数据，自动生成报表和图表。
   ```
4. 点击"生成分析"按钮
5. 观察流式分析进度

### 2. 预期结果验证
- ✅ 无网络连接错误
- ✅ 实时显示分析进度
- ✅ 返回完整的AI分析结果：
  - 最小可行产品(MVP)建议
  - 技术解决方案
  - 开发模块分解
- ✅ 支持导出功能（Markdown、PNG）

### 3. AWS后台日志验证
在AWS后台服务器终端中应该看到：
```
🔍 收到流式AI产品分析请求: {
  requirement: '...',
  language: 'zh',
  timestamp: '2025-07-04T17:32:26.502Z'
}
🤖 调用DeepSeek Chat API...
✅ DeepSeek Chat API响应成功
✅ MVP分析：DeepSeek API成功
✅ 技术方案：DeepSeek API成功
✅ 开发模块：DeepSeek API成功
```

## 📊 系统架构

```
┌─────────────────┐    HTTP请求    ┌─────────────────┐
│   前端应用      │  ────────────► │  AWS后台服务器   │
│ localhost:5173  │               │ localhost:3000  │
│                 │               │                 │
│ AIProductIdea   │               │ DeepSeek API    │
│ Generator.tsx   │               │ Server          │
└─────────────────┘               └─────────────────┘
                                          │
                                          ▼
                                 ┌─────────────────┐
                                 │ DeepSeek Chat   │
                                 │ AI API          │
                                 │ (实时大模型)     │
                                 └─────────────────┘
```

## 🔑 关键技术特性

### 1. 流式分析
- 支持服务器发送事件(SSE)
- 实时进度反馈
- 分步骤数据返回

### 2. 大模型集成
- DeepSeek Chat API
- 支持中英文分析
- JSON格式输出
- 超时控制(2分钟)

### 3. 容错机制
- API调用失败时使用备用逻辑
- JSON解析错误处理
- 网络超时处理

## 🛠 故障排除

### 常见问题

**1. 端口被占用**
```bash
# 查看端口占用
netstat -ano | findstr ":3000"
netstat -ano | findstr ":5173"

# 强制关闭进程
taskkill /PID [进程ID] /F
```

**2. AWS后台服务器启动失败**
- 检查`.env`文件是否存在
- 验证`DEEPSEEK_API_KEY`配置
- 确认依赖已安装：`npm install`

**3. 前端API调用失败**
- 确认Vite代理配置已移除
- 检查AWS后台服务器运行状态
- 验证CORS配置

**4. DeepSeek API调用失败**
- 检查API密钥有效性
- 验证网络连接
- 查看后台日志输出

## 📝 维护注意事项

### 定期检查
1. **DeepSeek API密钥**：确保密钥有效且有足够额度
2. **服务进程**：避免僵尸进程影响性能
3. **日志监控**：定期查看错误日志
4. **依赖更新**：保持依赖包最新版本

### 生产环境部署
1. **环境变量**：使用生产环境的API密钥
2. **CORS配置**：更新为生产域名
3. **错误监控**：集成Sentry等监控服务
4. **性能优化**：启用缓存和负载均衡

## 🎯 优势总结

### 相比Netlify Functions的优势
1. **无时间限制**：可支持长时间的大模型分析
2. **更好的控制**：完全控制服务器行为和配置
3. **实时响应**：支持流式数据传输
4. **成本效益**：避免serverless函数的时间限制费用

### 技术优势
1. **真实AI分析**：使用DeepSeek大模型进行实际分析
2. **用户体验**：流式进度反馈提升交互体验
3. **扩展性强**：易于添加新的AI功能和模型
4. **维护简单**：单一服务器，便于调试和监控

---

## 📞 技术支持

如遇问题，请按以下顺序排查：
1. 检查本文档的故障排除章节
2. 验证所有服务的运行状态
3. 查看后台服务器日志输出
4. 检查浏览器开发者工具的网络请求

**成功部署标志**：
- ✅ AWS后台：http://localhost:3000/health 返回健康状态
- ✅ 前端服务：http://localhost:5173 正常加载
- ✅ AI分析功能：能够正常生成产品分析报告
- ✅ 后台日志：显示DeepSeek API调用成功 