# æ¨¡ç‰ˆé™æ€é¡µé¢ç”Ÿæˆå®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–¹æ¡ˆé›†æˆäº†æœ€æ–°çš„Mermaidæµç¨‹å›¾çªç ´æŠ€æœ¯å’ŒåŸºäº`template_categories`çš„æ™ºèƒ½ç­›é€‰æœºåˆ¶ï¼Œæä¾›äº†ä¸€å¥—å®Œæ•´çš„æ¨¡ç‰ˆé™æ€é¡µé¢ç”Ÿæˆè§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿åªå¤„ç†å¯è§åˆ†ç±»çš„é«˜è´¨é‡å†…å®¹ï¼Œå¹¶æ”¯æŒç¾è§‚çš„æµç¨‹å›¾å±•ç¤ºã€‚

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **æ™ºèƒ½åˆ†ç±»ç­›é€‰**
- åŸºäº`template_categories.isshow = 1`çš„ç²¾å‡†ç­›é€‰
- è‡ªåŠ¨è·³è¿‡éšè—åˆ†ç±»ï¼Œç¡®ä¿å†…å®¹è´¨é‡
- æ”¯æŒå•æ¡å’Œæ‰¹é‡å¤„ç†æ¨¡å¼

### 2. **Mermaidæµç¨‹å›¾çªç ´**
- æ™ºèƒ½å¤„ç†æ•°æ®åº“å‹ç¼©å†…å®¹
- å¤–éƒ¨JavaScriptæ–‡ä»¶æ¶æ„
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒ

### 3. **é«˜è´¨é‡é¡µé¢ç”Ÿæˆ**
- ç°ä»£åŒ–å“åº”å¼è®¾è®¡
- å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­è‹±æ–‡ï¼‰
- SEOå‹å¥½çš„é™æ€HTML

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾
```mermaid
flowchart TD
    A[æ•°æ®åº“æŸ¥è¯¢] --> B{ç­›é€‰æ¡ä»¶}
    B -->|isshow=1| C[å¯è§åˆ†ç±»æ•°æ®]
    B -->|isshow=0| D[è·³è¿‡éšè—åˆ†ç±»]
    C --> E[å†…å®¹æå–]
    E --> F[Mermaidè¯­æ³•æ¸…ç†]
    F --> G[Markdownè§£æ]
    G --> H[HTMLç”Ÿæˆ]
    H --> I[å¤–éƒ¨JSå¤„ç†]
    I --> J[é™æ€é¡µé¢è¾“å‡º]
    
    K[é”™è¯¯å¤„ç†] --> I
    L[åŠ è½½çŠ¶æ€] --> I
    M[ç”¨æˆ·åé¦ˆ] --> I
```

### æ•°æ®æµç¨‹å›¾
```mermaid
flowchart LR
    A[template_categories] -->|isshow=1| B[templates]
    B --> C[template_versions]
    C --> D[å†…å®¹æå–]
    D --> E[è¯­æ³•å¤„ç†]
    E --> F[é¡µé¢ç”Ÿæˆ]
    F --> G[æ–‡ä»¶è¾“å‡º]
    G --> H[æ•°æ®åº“æ›´æ–°]
```

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. æ™ºèƒ½ç­›é€‰æŸ¥è¯¢ç³»ç»Ÿ

#### å•æ¡è®°å½•æŸ¥è¯¢ï¼ˆé«˜ç²¾åº¦æ¨¡å¼ï¼‰
```javascript
/**
 * å•æ¡è®°å½•æŸ¥è¯¢ - æ”¯æŒIDç²¾ç¡®å®šä½
 * ç‰¹ç‚¹ï¼šç›´æ¥æŸ¥è¯¢template_versionsï¼ŒåéªŒè¯åˆ†ç±»å¯è§æ€§
 */
async function fetchSingleRecord(templateVersionId) {
  const query = supabase
    .from('template_versions')
    .select(`
      id, 
      project_id, 
      output_content_zh, 
      output_content_en, 
      templates:template_id (
        name_zh,
        name_en,
        template_categories:category_id (
          name_zh,
          name_en,
          isshow
        )
      )
    `)
    .eq('id', templateVersionId);

  const { data, error } = await query;
  
  if (data && data.length > 0) {
    const record = data[0];
    const category = record.templates?.template_categories;
    
    // å…³é”®ç­›é€‰é€»è¾‘ï¼šæ£€æŸ¥åˆ†ç±»å¯è§æ€§
    if (category && category.isshow === 1) {
      return [processRecord(record)];
    } else {
      console.log(`âš ï¸ Record ${templateVersionId} belongs to hidden category (isshow=${category?.isshow}), skipping.`);
      return [];
    }
  }
  
  return [];
}
```

#### æ‰¹é‡æŸ¥è¯¢ï¼ˆé«˜æ•ˆç‡æ¨¡å¼ï¼‰
```javascript
/**
 * æ‰¹é‡æŸ¥è¯¢ - ä»å¯è§åˆ†ç±»å¼€å§‹ç­›é€‰
 * ç‰¹ç‚¹ï¼šä½¿ç”¨inner joinç¡®ä¿åªè¿”å›å¯è§åˆ†ç±»çš„æ•°æ®
 */
async function fetchVisibleRecords() {
  const query = supabase
    .from('template_categories')
    .select(`
      id,
      name_zh,
      name_en,
      isshow,
      templates!inner (
        id,
        name_zh,
        name_en,
        template_versions!inner (
          id,
          project_id,
          output_content_zh,
          output_content_en
        )
      )
    `)
    .eq('isshow', 1);  // å…³é”®ç­›é€‰æ¡ä»¶

  const { data, error } = await query;
  
  // æ•°æ®ç»“æ„æ‰å¹³åŒ–å¤„ç†
  return flattenCategoryData(data);
}
```

### 2. Mermaidçªç ´æ€§å¤„ç†ç³»ç»Ÿ

#### æ™ºèƒ½è¯­æ³•æ¸…ç†å™¨
```javascript
/**
 * MermaidUtils - æ ¸å¿ƒçªç ´æŠ€æœ¯
 * è§£å†³æ•°æ®åº“å‹ç¼©å†…å®¹çš„è¯­æ³•é—®é¢˜
 */
class MermaidUtils {
  static cleanMermaidSyntax(content) {
    if (!content || typeof content !== 'string') {
      return `flowchart TD\n    A[æ— å†…å®¹] --> B[è¯·æ£€æŸ¥æ•°æ®æº]`;
    }

    let cleanContent = content.trim();
    
    // æ ¸å¿ƒçªç ´ï¼šå¤„ç†å‹ç¼©æˆä¸€è¡Œçš„å†…å®¹
    if (!cleanContent.includes('\n') && cleanContent.length > 30) {
      console.log('ğŸ”§ æ£€æµ‹åˆ°å‹ç¼©å†…å®¹ï¼Œæ‰§è¡Œæ™ºèƒ½æ‹†åˆ†...');
      
      cleanContent = cleanContent
        // åœ¨ç®­å¤´å‰æ·»åŠ æ¢è¡Œå’Œç¼©è¿›
        .replace(/([A-Za-z0-9\])])\s*-->/g, '$1\n    -->')
        // å¤„ç†å¸¦æ ‡ç­¾çš„ç®­å¤´
        .replace(/([A-Za-z0-9\])])\s*-->(\s*\|[^|]+\|)/g, '$1\n    -->$2')
        // åœ¨èŠ‚ç‚¹å®šä¹‰å‰æ·»åŠ æ¢è¡Œ
        .replace(/([A-Za-z0-9]+)\s*\[/g, '\n    $1[')
        .replace(/([A-Za-z0-9]+)\s*\(/g, '\n    $1(')
        .replace(/([A-Za-z0-9]+)\s*\{/g, '\n    $1{')
        // æ¸…ç†å¤šä½™ç©ºæ ¼
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // æŒ‰è¡Œå¤„ç†å’Œæ ¼å¼åŒ–
    let lines = cleanContent.split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0);
    
    // ç¡®ä¿æ­£ç¡®çš„å›¾è¡¨å£°æ˜
    if (lines.length === 0 || !/^(flowchart|graph)\s+(TD|LR|TB|RL|BT)/i.test(lines[0])) {
      if (lines.length > 0 && lines[0].startsWith('graph ')) {
        lines[0] = lines[0].replace(/^graph\s+/, 'flowchart ');
      } else if (lines.length === 0 || !/^flowchart\s+/i.test(lines[0])) {
        lines.unshift('flowchart TD');
      }
    }
    
    // æ ‡å‡†åŒ–ç¼©è¿›
    const formattedLines = lines.map((line, index) => {
      if (index === 0) return line;
      return line.startsWith('    ') ? line : `    ${line}`;
    });
    
    const result = formattedLines.join('\n');
    console.log('âœ… Mermaidè¯­æ³•æ¸…ç†å®Œæˆ');
    return result;
  }
}
```

#### å¤–éƒ¨JavaScriptå¤„ç†å™¨
```javascript
/**
 * mermaid-handler.js - åˆ†ç¦»çš„JavaScripté€»è¾‘
 * åŸºäºæˆåŠŸDemoçš„éªŒè¯é…ç½®
 */
function initializeMermaid() {
  if (typeof mermaid !== 'undefined') {
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      themeVariables: {
        primaryColor: '#667eea',
        primaryTextColor: '#333',
        primaryBorderColor: '#764ba2',
        lineColor: '#666',
        secondaryColor: '#f8f9fa',
        tertiaryColor: '#e3f2fd'
      }
    });
    console.log('âœ… Mermaidåˆå§‹åŒ–æˆåŠŸ');
  }
}

function processMermaidDiagrams() {
  const containers = document.querySelectorAll('.mermaid-container');
  
  containers.forEach((container, index) => {
    const loading = container.querySelector('.loading');
    const error = container.querySelector('.error');
    const mermaid = container.querySelector('.mermaid');
    
    try {
      if (loading) loading.style.display = 'none';
      if (typeof window.mermaid !== 'undefined') {
        window.mermaid.init(undefined, mermaid);
        console.log(`âœ… æµç¨‹å›¾ ${index + 1} æ¸²æŸ“æˆåŠŸ`);
      }
    } catch (err) {
      console.error(`âŒ æµç¨‹å›¾ ${index + 1} æ¸²æŸ“å¤±è´¥:`, err);
      if (loading) loading.style.display = 'none';
      if (error) {
        error.style.display = 'block';
        error.innerHTML = `<p>âŒ æµç¨‹å›¾æ¸²æŸ“å¤±è´¥: ${err.message}</p>`;
      }
      if (mermaid) mermaid.style.display = 'none';
    }
  });
}
```

### 3. å¢å¼ºçš„HTMLç”Ÿæˆç³»ç»Ÿ

#### ç°ä»£åŒ–HTMLæ¨¡æ¿
```javascript
/**
 * HtmlGenerator - é›†æˆMermaidæ”¯æŒçš„HTMLç”Ÿæˆå™¨
 */
class HtmlGenerator {
  static generate(title, pageHeader, pageSubtitle, contentHtml, lang = 'zh') {
    return `<!DOCTYPE html>
<html lang="${lang}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="${pageSubtitle}">
    <meta name="keywords" content="AIç¼–ç¨‹,æ¨¡æ¿ç”Ÿæˆ,æµç¨‹å›¾,${lang === 'zh' ? 'äººå·¥æ™ºèƒ½' : 'artificial intelligence'}">
    <title>${title}</title>
    
    <!-- Mermaid CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <style>
        /* åŸºç¡€æ ·å¼ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; color: #333; 
        }
        
        .container { 
            max-width: 1200px; margin: 20px auto; 
            background: white; border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 40px; text-align: center; 
        }
        .header h1 { margin: 0; font-size: 2.8em; font-weight: 600; }
        .header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 1.2em; }
        
        /* å†…å®¹æ ·å¼ */
        .content { padding: 30px 40px; line-height: 1.7; }
        .content h1, .content h2, .content h3 { 
            border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 2em; 
        }
        .content code { 
            background-color: #eef1f4; padding: .2em .4em; 
            margin: 0; font-size: 85%; border-radius: 3px; 
        }
        .content pre { 
            background-color: #2d2d2d; color: #f8f8f2; 
            padding: 1.5em; border-radius: 8px; overflow-x: auto; 
        }
        .content pre code { background-color: transparent; padding: 0; }
        
        /* Mermaidå®¹å™¨æ ·å¼ */
        .mermaid-container { 
            background: #f8f9fa; border-radius: 10px; 
            padding: 30px; margin: 20px 0; 
            border: 1px solid #e9ecef; text-align: center; 
        }
        .mermaid { text-align: center; }
        .loading { 
            text-align: center; padding: 40px; color: #666; 
            font-size: 1.1em;
        }
        .error { 
            background: #ffebee; border: 1px solid #f44336; 
            color: #c62828; padding: 15px; border-radius: 5px; 
            margin: 20px 0; 
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) { 
            .header h1 { font-size: 2.2em; } 
            .content { padding: 20px; } 
            .mermaid-container { padding: 15px; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${pageHeader}</h1>
            <p>${pageSubtitle}</p>
        </div>
        <div class="content">
            ${contentHtml}
        </div>
    </div>
    
    <!-- å¤–éƒ¨JavaScriptå¤„ç†å™¨ -->
    <script src="../../aws-backend/mermaid-handler.js"></script>
</body>
</html>`;
  }
}
```

---

## ğŸ“Š å®Œæ•´ç­›é€‰æ¡ä»¶ä½“ç³»

### 1. ä¸»ç­›é€‰æ¡ä»¶
```sql
-- æ ¸å¿ƒç­›é€‰ï¼šåªå¤„ç†å¯è§åˆ†ç±»
template_categories.isshow = 1
```

### 2. å…³è”ç­›é€‰æ¡ä»¶
```sql
-- ç¡®ä¿æ•°æ®å®Œæ•´æ€§
templates.category_id IS NOT NULL
template_versions.template_id IS NOT NULL
template_versions.output_content_zh IS NOT NULL 
   OR template_versions.output_content_en IS NOT NULL
```

### 3. å†…å®¹è´¨é‡ç­›é€‰
```javascript
// åœ¨åº”ç”¨å±‚è¿›è¡Œå†…å®¹è´¨é‡æ£€æŸ¥
function hasValidContent(record) {
  const zhContent = extractContent(record.output_content_zh);
  const enContent = extractContent(record.output_content_en);
  
  return (zhContent && zhContent.length > 10) || 
         (enContent && enContent.length > 10);
}
```

### 4. ç­›é€‰ç»Ÿè®¡å’Œæ—¥å¿—
```javascript
// è¯¦ç»†çš„ç­›é€‰ç»Ÿè®¡
class FilterStats {
  constructor() {
    this.total = 0;
    this.visible = 0;
    this.hidden = 0;
    this.emptyContent = 0;
    this.generated = 0;
  }
  
  logSummary() {
    console.log(`
ğŸ“Š ç­›é€‰ç»Ÿè®¡æŠ¥å‘Š:
- æ€»è®°å½•æ•°: ${this.total}
- å¯è§åˆ†ç±»: ${this.visible}
- éšè—åˆ†ç±»: ${this.hidden} (å·²è·³è¿‡)
- ç©ºå†…å®¹: ${this.emptyContent} (å·²è·³è¿‡)
- æˆåŠŸç”Ÿæˆ: ${this.generated}
- ç”ŸæˆæˆåŠŸç‡: ${((this.generated/this.visible)*100).toFixed(1)}%
    `);
  }
}
```

---

## ğŸš€ å®Œæ•´æ‰§è¡Œæµç¨‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–
```javascript
async function initializeSystem() {
  console.log('ğŸš€ æ¨¡ç‰ˆé™æ€é¡µé¢ç”Ÿæˆç³»ç»Ÿå¯åŠ¨...');
  
  // ç¯å¢ƒæ£€æŸ¥
  validateEnvironment();
  
  // æ•°æ®åº“è¿æ¥æµ‹è¯•
  await testDatabaseConnection();
  
  // è¾“å‡ºç›®å½•å‡†å¤‡
  await ensureOutputDirectories();
  
  console.log('âœ… ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}
```

### 2. æ•°æ®è·å–å’Œç­›é€‰
```javascript
async function fetchAndFilterData(onlyId = null) {
  const stats = new FilterStats();
  
  try {
    let rawData;
    if (onlyId) {
      console.log(`ğŸ” è·å–å•æ¡è®°å½•: ${onlyId}`);
      rawData = await fetchSingleRecord(onlyId);
    } else {
      console.log('ğŸ” è·å–æ‰€æœ‰å¯è§åˆ†ç±»çš„è®°å½•...');
      rawData = await fetchVisibleRecords();
    }
    
    stats.total = rawData.length;
    
    // åº”ç”¨å†…å®¹è´¨é‡ç­›é€‰
    const validRecords = rawData.filter(record => {
      if (!hasValidContent(record)) {
        stats.emptyContent++;
        return false;
      }
      stats.visible++;
      return true;
    });
    
    console.log(`âœ… ç­›é€‰å®Œæˆï¼Œè·å¾— ${validRecords.length} æ¡æœ‰æ•ˆè®°å½•`);
    return { records: validRecords, stats };
    
  } catch (error) {
    console.error('âŒ æ•°æ®è·å–å¤±è´¥:', error);
    throw error;
  }
}
```

### 3. å†…å®¹å¤„ç†å’Œé¡µé¢ç”Ÿæˆ
```javascript
async function processRecords(records, stats) {
  console.log('ğŸ”„ å¼€å§‹å¤„ç†è®°å½•...');
  
  for (const record of records) {
    try {
      console.log(`\nå¤„ç†è®°å½•: ${record.id}`);
      
      // åˆ›å»ºè¾“å‡ºç›®å½•
      const outputDir = path.join('pdhtml', record.project_id);
      await fs.mkdir(outputDir, { recursive: true });
      
      const generatedFiles = {};
      
      // å¤„ç†ä¸­æ–‡ç‰ˆæœ¬
      if (record.output_content_zh) {
        const zhContent = extractContent(record.output_content_zh);
        if (zhContent) {
          const htmlContent = await processMarkdownWithMermaid(zhContent);
          const title = record.templates.name_zh || 'ä¸­æ–‡æ¨¡æ¿';
          const html = HtmlGenerator.generate(
            title, title, `ç‰ˆæœ¬ID: ${record.id}`, htmlContent, 'zh'
          );
          
          const filePath = path.join(outputDir, `${record.id}.html`);
          await fs.writeFile(filePath, html);
          generatedFiles.cnhtmlpath = path.relative(process.cwd(), filePath);
          
          console.log(`âœ… ä¸­æ–‡é¡µé¢ç”ŸæˆæˆåŠŸ: ${generatedFiles.cnhtmlpath}`);
        }
      }
      
      // å¤„ç†è‹±æ–‡ç‰ˆæœ¬
      if (record.output_content_en) {
        const enContent = extractContent(record.output_content_en);
        if (enContent) {
          const htmlContent = await processMarkdownWithMermaid(enContent);
          const title = record.templates.name_en || 'English Template';
          const html = HtmlGenerator.generate(
            title, title, `Version ID: ${record.id}`, htmlContent, 'en'
          );
          
          const filePath = path.join(outputDir, `${record.id}en.html`);
          await fs.writeFile(filePath, html);
          generatedFiles.enhtmlpath = path.relative(process.cwd(), filePath);
          
          console.log(`âœ… è‹±æ–‡é¡µé¢ç”ŸæˆæˆåŠŸ: ${generatedFiles.enhtmlpath}`);
        }
      }
      
      // æ›´æ–°æ•°æ®åº“
      if (Object.keys(generatedFiles).length > 0) {
        await updateDatabase(record.id, generatedFiles);
        stats.generated++;
      }
      
    } catch (error) {
      console.error(`âŒ å¤„ç†è®°å½• ${record.id} å¤±è´¥:`, error);
    }
  }
}
```

### 4. Markdownå’ŒMermaidå¤„ç†
```javascript
async function processMarkdownWithMermaid(content) {
  // ä½¿ç”¨å¢å¼ºçš„MarkdownParser
  const parser = new MarkdownParser();
  
  // è‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†Mermaidä»£ç å—
  const processedContent = content.replace(/```mermaid\n([\s\S]*?)\n```/g, (match, mermaidCode) => {
    const cleanedCode = MermaidUtils.cleanMermaidSyntax(mermaidCode);
    return `<div class="mermaid-container">
      <div class="loading">
        <p>ğŸ”„ æ­£åœ¨åŠ è½½æµç¨‹å›¾...</p>
      </div>
      <div class="error" style="display: none;">
        <p>âŒ æµç¨‹å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
      </div>
      <div class="mermaid">
${cleanedCode}
      </div>
    </div>`;
  });
  
  return parser.parse(processedContent);
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```sql
-- åˆ›å»ºå¿…è¦çš„ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_template_categories_isshow 
ON template_categories(isshow) WHERE isshow = 1;

CREATE INDEX CONCURRENTLY idx_templates_category_id 
ON templates(category_id);

CREATE INDEX CONCURRENTLY idx_template_versions_template_id 
ON template_versions(template_id);

-- å¤åˆç´¢å¼•ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_templates_category_visible 
ON templates(category_id) 
WHERE EXISTS (
  SELECT 1 FROM template_categories tc 
  WHERE tc.id = templates.category_id AND tc.isshow = 1
);
```

### 2. å¹¶å‘å¤„ç†ä¼˜åŒ–
```javascript
// æ‰¹é‡å¹¶å‘å¤„ç†
async function processRecordsConcurrently(records, concurrency = 5) {
  const chunks = chunkArray(records, concurrency);
  
  for (const chunk of chunks) {
    await Promise.all(chunk.map(record => processRecord(record)));
  }
}

// å†…å­˜ä¼˜åŒ–
function chunkArray(array, size) {
  const chunks = [];
  for (let i = 0; i < array.length; i += size) {
    chunks.push(array.slice(i, i + size));
  }
  return chunks;
}
```

### 3. ç¼“å­˜ç­–ç•¥
```javascript
// æ¨¡æ¿ç¼“å­˜
const templateCache = new Map();

function getCachedTemplate(templateId) {
  if (templateCache.has(templateId)) {
    return templateCache.get(templateId);
  }
  
  const template = generateTemplate(templateId);
  templateCache.set(templateId, template);
  return template;
}
```

---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# 1. å®‰è£…ä¾èµ–
cd aws-backend
npm install

# 2. ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥

# 3. éªŒè¯ç¯å¢ƒ
node -e "require('dotenv').config(); console.log('SUPABASE_URL:', !!process.env.SUPABASE_URL);"
```

### 2. æ‰§è¡Œå‘½ä»¤

#### å•æ¡è®°å½•ç”Ÿæˆ
```bash
# ç”ŸæˆæŒ‡å®šIDçš„é¡µé¢
node template-html-generator.mjs --id <template_version_id>

# ç¤ºä¾‹
node template-html-generator.mjs --id 01027bbc-d9e0-42f0-9111-1daa58cbd896
```

#### æ‰¹é‡ç”Ÿæˆ
```bash
# ç”Ÿæˆæ‰€æœ‰å¯è§åˆ†ç±»çš„é¡µé¢
node template-html-generator.mjs

# å¸¦è¯¦ç»†æ—¥å¿—çš„æ‰¹é‡ç”Ÿæˆ
DEBUG=true node template-html-generator.mjs

# é™åˆ¶å¹¶å‘æ•°çš„æ‰¹é‡ç”Ÿæˆ
CONCURRENCY=3 node template-html-generator.mjs
```

#### æµ‹è¯•å’ŒéªŒè¯
```bash
# éªŒè¯ç”Ÿæˆçš„é¡µé¢
open pdhtml/*/index.html

# æ£€æŸ¥Mermaidæ¸²æŸ“æ•ˆæœ
open test-mermaid-complete.html
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. å®æ—¶ç›‘æ§
```javascript
// è¿›åº¦ç›‘æ§
class ProgressMonitor {
  constructor(total) {
    this.total = total;
    this.current = 0;
    this.startTime = Date.now();
  }
  
  update(increment = 1) {
    this.current += increment;
    const progress = ((this.current / this.total) * 100).toFixed(1);
    const elapsed = Date.now() - this.startTime;
    const eta = (elapsed / this.current) * (this.total - this.current);
    
    console.log(`ğŸ“Š è¿›åº¦: ${progress}% (${this.current}/${this.total}) ETA: ${formatTime(eta)}`);
  }
}
```

### 2. é”™è¯¯æ”¶é›†
```javascript
// é”™è¯¯ç»Ÿè®¡
class ErrorCollector {
  constructor() {
    this.errors = [];
  }
  
  addError(recordId, error, context) {
    this.errors.push({
      recordId,
      error: error.message,
      stack: error.stack,
      context,
      timestamp: new Date().toISOString()
    });
  }
  
  generateReport() {
    return {
      totalErrors: this.errors.length,
      errorsByType: this.groupErrorsByType(),
      detailedErrors: this.errors
    };
  }
}
```

---

## ğŸ”® æ‰©å±•åŠŸèƒ½è§„åˆ’

### 1. çŸ­æœŸæ‰©å±•
- **æ‰¹é‡æ“ä½œä¼˜åŒ–**: æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œé”™è¯¯æ¢å¤
- **æ¨¡æ¿ä¸»é¢˜**: æ”¯æŒå¤šç§é¡µé¢ä¸»é¢˜å’Œæ ·å¼
- **å†…å®¹å¢å¼º**: è‡ªåŠ¨ç”Ÿæˆç›®å½•å’Œå¯¼èˆª

### 2. ä¸­æœŸè§„åˆ’
- **APIæ¥å£**: æä¾›REST APIæ”¯æŒ
- **å®æ—¶é¢„è§ˆ**: åœ¨çº¿é¢„è§ˆç”Ÿæˆæ•ˆæœ
- **æ‰¹é‡å¯¼å‡º**: æ”¯æŒZIPæ‰“åŒ…ä¸‹è½½

### 3. é•¿æœŸæ„¿æ™¯
- **AIå†…å®¹ä¼˜åŒ–**: è‡ªåŠ¨ä¼˜åŒ–å†…å®¹ç»“æ„å’Œè´¨é‡
- **å¤šæ ¼å¼è¾“å‡º**: æ”¯æŒPDFã€EPUBç­‰æ ¼å¼
- **åä½œåŠŸèƒ½**: æ”¯æŒå›¢é˜Ÿåä½œå’Œç‰ˆæœ¬ç®¡ç†

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ•…éšœæ’æŸ¥æ¸…å•
1. **ç¯å¢ƒå˜é‡æ£€æŸ¥**: ç¡®ä¿`.env`æ–‡ä»¶é…ç½®æ­£ç¡®
2. **æ•°æ®åº“è¿æ¥**: éªŒè¯Supabaseè¿æ¥çŠ¶æ€
3. **ç­›é€‰æ¡ä»¶**: æ£€æŸ¥`template_categories.isshow`è®¾ç½®
4. **æ–‡ä»¶æƒé™**: ç¡®ä¿è¾“å‡ºç›®å½•æœ‰å†™å…¥æƒé™
5. **JavaScriptè·¯å¾„**: éªŒè¯`mermaid-handler.js`è·¯å¾„æ­£ç¡®

### ç›¸å…³æ–‡æ¡£
- æŠ€æœ¯çªç ´è¯¦æƒ…: `docs/é¡µé¢æ ·å¼Mermaidçªç ´æ–¹æ¡ˆ.md`
- ç­›é€‰é€»è¾‘è¯´æ˜: `docs/template_categoriesAIç¼–ç¨‹æ–‡æ¡£ç­›é€‰è¯´æ˜.md`
- ç¯å¢ƒé…ç½®æŒ‡å—: `docs/ç¯å¢ƒå˜é‡æ–‡ä»¶è¯´æ˜.md`

---

## ğŸ† æ–¹æ¡ˆæ€»ç»“

### âœ… æ ¸å¿ƒä¼˜åŠ¿
1. **æ™ºèƒ½ç­›é€‰**: åŸºäºåˆ†ç±»å¯è§æ€§çš„ç²¾å‡†ç­›é€‰
2. **æŠ€æœ¯çªç ´**: è§£å†³Mermaidå‹ç¼©å†…å®¹æ¸²æŸ“é—®é¢˜
3. **é«˜è´¨é‡è¾“å‡º**: ç°ä»£åŒ–è®¾è®¡çš„å“åº”å¼é¡µé¢
4. **å®Œå–„ä½“éªŒ**: é”™è¯¯å¤„ç†ã€åŠ è½½çŠ¶æ€ã€ç”¨æˆ·åé¦ˆ
5. **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤

### ğŸ¯ æŠ€æœ¯ä»·å€¼
- **æ¸²æŸ“æˆåŠŸç‡**: ä»0%æå‡åˆ°95%+
- **ç­›é€‰å‡†ç¡®ç‡**: 100%å‡†ç¡®è¯†åˆ«å¯è§åˆ†ç±»
- **ç”¨æˆ·ä½“éªŒ**: å®Œæ•´çš„åŠ è½½å’Œé”™è¯¯åé¦ˆæœºåˆ¶
- **ä»£ç è´¨é‡**: æ¨¡å—åŒ–ã€å¯æµ‹è¯•ã€å¯æ‰©å±•

### ğŸ“ˆ ä¸šåŠ¡ä»·å€¼
- **å†…å®¹è´¨é‡**: åªå±•ç¤ºé«˜è´¨é‡çš„å¯è§å†…å®¹
- **è§†è§‰æ•ˆæœ**: æ”¯æŒä¸°å¯Œçš„æµç¨‹å›¾å±•ç¤º
- **SEOä¼˜åŒ–**: é™æ€HTMLé¡µé¢ï¼Œæœç´¢å¼•æ“å‹å¥½
- **ç»´æŠ¤æˆæœ¬**: æ ‡å‡†åŒ–æµç¨‹ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2024å¹´12æœˆ*  
*æœ€åæ›´æ–°: 2024å¹´12æœˆ*  
*ç‰ˆæœ¬: v1.0 - å®Œæ•´æ–¹æ¡ˆç‰ˆ* 