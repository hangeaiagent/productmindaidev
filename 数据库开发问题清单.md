# 数据库开发问题清单

## 概述
本文档总结了在ProductMind AI项目批量生产过程中遇到的数据库相关问题、解决方案和经验教训。

## 问题汇总

### 1. 表名错误问题

**问题描述**: 
- 脚本中使用了错误的表名 `ai_funding`
- 实际数据库中的表名是 `user_projects`

**错误信息**:
```
relation "public.ai_funding" does not exist
```

**解决方案**:
- 查看Supabase迁移文件 `supabase/migrations/20250522085855_dawn_band.sql`
- 确认真实表名为 `user_projects`
- 更新所有相关脚本中的表名引用


### 2. 外键约束违反问题

**问题描述**:
- 使用随机生成的UUID作为 `template_id` 和 `project_id`
- 这些UUID在数据库中不存在，违反外键约束

**错误信息**:
```
Key (template_id)=(1ac25904-d98e-4ed8-baa8-f99ff911208d) is not present in table "templates"
```

**解决方案**:
- 查询数据库中真实存在的记录ID
- 使用真实存在的 `template_id` 和 `project_id`
- 或者创建新的记录而不是使用随机UUID


### 3. 必需字段缺失问题

**问题描述**:
- `template_versions` 表的 `created_by` 字段是必需的
- 脚本中没有提供有效的用户UUID

**错误信息**:
```
null value in column "created_by" of relation "template_versions" violates not-null constraint
```

**解决方案**:
- 添加 `created_by: '00000000-0000-0000-0000-000000000000'` (系统用户UUID)
- 或者查询真实的用户ID


### 4. UUID格式错误问题

**问题描述**:
- 使用字符串 "system-batch" 作为UUID
- UUID必须是有效的UUID格式

**错误信息**:
```
invalid input syntax for type uuid: "system-batch"
```

**解决方案**:
- 使用有效的UUID格式: `00000000-0000-0000-0000-000000000000`
- 或者使用 `crypto.randomUUID()` 生成新的UUID


### 5. 环境变量配置问题

**问题描述**:
- 环境变量路径错误: `dotenv.config({ path: 'aws-backend/.env' })`
- 应该使用根目录的 `.env` 文件

**解决方案**:
- 修改为 `dotenv.config()`
- 确保使用正确的环境变量名


## 经验教训

1. **表名验证**: 在开发前确认数据库表名和结构
2. **外键约束**: 理解并遵守数据库的外键约束
3. **必需字段**: 确保所有必需字段都有有效值
4. **UUID格式**: 使用正确的UUID格式
5. **环境配置**: 正确配置和使用环境变量
6. **错误处理**: 实现完善的错误处理机制
7. **测试验证**: 在正式运行前进行充分的测试


## 后续改进建议

1. **数据库迁移管理**: 建立完善的数据库迁移流程
2. **数据验证层**: 实现统一的数据验证机制
3. **错误监控**: 建立数据库错误监控和报警系统
4. **文档维护**: 保持数据库文档的及时更新
5. **自动化测试**: 建立数据库操作的自动化测试

---

**文档版本**: 1.0  
**创建时间**: 2024年12月19日  
**最后更新**: 2024年12月19日  
**维护人员**: ProductMind AI开发团队
